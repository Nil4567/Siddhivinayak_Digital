async function loadBill(orderCode) {
  $("debugMsg").textContent = "Loading bill...";
  try {
    const { data, error } = await supabaseClient
      .from("completed_orders")
      .select(`
        order_id,
        order_code,
        customer_name,
        customer_contact,
        job_description,
        total_amount,
        advance_amount,
        pending_received,
        total_received,
        pending_balance,
        created_at,
        completed_at
      `)
      .eq("order_code", orderCode)
      .limit(1)
      .single();

    if (error) {
      console.error("Supabase error:", error);
      $("debugMsg").textContent = "Bill not found or permission denied. Check console.";
      return;
    }
    if (!data) {
      $("debugMsg").textContent = "No data returned for this code.";
      return;
    }

    // Base values from DB
    const total = Number(data.total_amount ?? 0);
    const advance = Number(data.advance_amount ?? 0);
    const pendingReceived = Number(data.pending_received ?? 0);

    // Prefer DB-derived values if present
    const totalReceivedDB = (data.total_received !== null && data.total_received !== undefined) ? Number(data.total_received) : null;
    const pendingBalanceDB = (data.pending_balance !== null && data.pending_balance !== undefined) ? Number(data.pending_balance) : null;

    // Compute fallback values
    const totalReceived = totalReceivedDB !== null ? totalReceivedDB : (advance + pendingReceived);
    const pendingBalance = pendingBalanceDB !== null ? pendingBalanceDB : Math.max(0, total - totalReceived);

    // Fill UI fields
    $("billCode").textContent = "Bill Code: " + (data.order_code || "—");
    const completedAt = data.completed_at ? new Date(data.completed_at) : new Date();
    $("billDate").textContent = "Date: " + completedAt.toISOString().split("T")[0];

    $("custName").textContent = data.customer_name || "—";
    $("custContact").textContent = data.customer_contact || "—";
    $("jobDesc").textContent = data.job_description || "—";

    $("itemDesc").textContent = data.job_description || "—";
    $("itemRate").textContent = fmt(total);
    $("itemAmount").textContent = fmt(total);

    $("totalAmount").textContent = fmt(total);
    $("advanceAmount").textContent = fmt(advance);
    $("pendingReceived").textContent = fmt(pendingReceived);
    $("totalReceived").textContent = fmt(totalReceived);
    $("pendingBalance").textContent = fmt(pendingBalance);

    // === CORRECT: Total Payable is the pending balance ===
    $("grandTotal").textContent = fmt(pendingBalance);

    // Show PAID stamp if payable is zero (or effectively zero)
    const paidStamp = $("paidStamp");
    if (Number(pendingBalance) <= 0.0001) {
      paidStamp.classList.add("visible");
    } else {
      paidStamp.classList.remove("visible");
    }

    $("debugMsg").textContent = "";
  } catch (err) {
    console.error("loadBill exception:", err);
    $("debugMsg").textContent = "Error loading bill. See console for details.";
  }
}
