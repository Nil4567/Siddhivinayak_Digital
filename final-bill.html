<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bill Token - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin:20px; background:#fff; }
    .invoice { max-width:700px; margin:auto; border:1px solid #ccc; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .header { display:flex; align-items:center; justify-content:center; gap:15px; margin-bottom:20px; }
    .logo { width:80px; height:80px; flex-shrink:0; }
    .logo img { width:100%; height:100%; object-fit:contain; }
    h1 { margin:0; color:#2c3e50; font-size:24px; }
    .details { margin:20px 0; }
    .details p { margin:6px 0; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; }
    th { background:#2ecc71; color:#fff; }
    .total { text-align:right; font-weight:bold; margin-top:10px; }
    .footer { text-align:center; margin-top:30px; font-size:14px; color:#555; }
    .footer button { background:#3498db; color:#fff; border:none; padding:8px 14px; border-radius:4px; cursor:pointer; margin:5px; }
    .footer button:hover { background:#2980b9; }
  </style>
</head>
<body>
  <div class="invoice" id="billCard">
    <div class="header">
      <div class="logo">
        <!-- Replace logo.png with your actual logo path or Supabase public URL -->
        <img src="https://qcyqjcxzytjtsikzrdyv.supabase.co/storage/v1/object/sign/logo/Screenshot%202025-12-16%20214616.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV84MjQxMmYwMC04MTBiLTQ3MGItODRjMy04YmE1MTE4YTM3ZjAiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJsb2dvL1NjcmVlbnNob3QgMjAyNS0xMi0xNiAyMTQ2MTYucG5nIiwiaWF0IjoxNzY1OTAyNDQ2LCJleHAiOjI2Mjk5MDI0NDZ9.Z9Xy0O-adqVePn5wJmG8HBSY2TlIXJ3dBzMJJAMg93g" alt="Shop Logo">
      </div>
      <h1>Siddhivinayak Digital</h1>
    </div>

    <div class="details" id="orderDetails">
      <!-- Order details will be injected here -->
    </div>

    <table>
      <thead>
        <tr>
          <th>Description</th>
          <th>Amount (‚Çπ)</th>
        </tr>
      </thead>
      <tbody id="billTable"></tbody>
    </table>

    <div class="total" id="totalAmount"></div>

    <div class="footer">
      <p>üôè Thank you for your business!</p>
      <button onclick="window.print()">Print Bill</button>
      <button id="downloadBtn">Download PNG</button>
      <button id="shareBtn">Share Bill</button>
    </div>
  </div>

  <!-- Supabase SDK + html2canvas + config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    async function loadBill() {
      const params = new URLSearchParams(window.location.search);
      const orderCode = params.get("code");

      if (!orderCode) {
        document.getElementById("orderDetails").innerHTML = "<p>No order code provided.</p>";
        return;
      }

      const { data, error } = await supabaseClient
        .from("completed_orders")
        .select("*")
        .eq("order_code", orderCode)
        .single();

      if (error || !data) {
        document.getElementById("orderDetails").innerHTML = "<p>Error loading order.</p>";
        return;
      }

      // Inject order details
      document.getElementById("orderDetails").innerHTML = `
        <p><strong>Order Code:</strong> ${data.order_code}</p>
        <p><strong>Customer:</strong> ${data.customer_name}</p>
        <p><strong>Mobile:</strong> ${data.customer_contact}</p>
        <p><strong>Job:</strong> ${data.job_description}</p>
        <p><strong>Completed Date:</strong> ${data.completed_at ? new Date(data.completed_at).toLocaleDateString() : ""}</p>
      `;

      // Build bill table
      const billRows = `
        <tr><td>Total Amount</td><td>${data.total_amount ?? 0}</td></tr>
        <tr><td>Advance Received</td><td>${data.advance_amount ?? 0}</td></tr>
        <tr><td>Pending Received</td><td>${data.pending_received ?? 0}</td></tr>
      `;
      document.getElementById("billTable").innerHTML = billRows;

      const totalReceived = (data.advance_amount ?? 0) + (data.pending_received ?? 0);
      document.getElementById("totalAmount").textContent = "Total Received: ‚Çπ" + totalReceived.toFixed(2);
    }

    // Download PNG
    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const card = document.getElementById("billCard");
      const canvas = await html2canvas(card, { scale: 2, useCORS: true });
      canvas.toBlob(blob => {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "bill.png";
        a.click();
      }, "image/png");
    });

    // Share Bill
    document.getElementById("shareBtn").addEventListener("click", async () => {
      const card = document.getElementById("billCard");
      if (!navigator.share && !navigator.canShare) {
        alert("Sharing not supported on this browser/device.");
        return;
      }
      const canvas = await html2canvas(card, { scale: 2, useCORS: true });
      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      const file = new File([blob], "bill.png", { type: "image/png" });

      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: "Bill Token",
          text: "Here is your bill from Siddhivinayak Digital"
        });
      } else if (navigator.share) {
        await navigator.share({
          title: "Bill Token",
          text: "Here is your bill from Siddhivinayak Digital",
          url: window.location.href
        });
      } else {
        alert("Sharing not available.");
      }
    });

    loadBill();
  </script>
</body>
</html>
