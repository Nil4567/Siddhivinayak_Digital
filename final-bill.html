<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Final Bill - Siddhivinayak Digital</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Segoe UI,Arial,sans-serif;
  background:#f4f6f9;
  padding:40px;
  display:flex;
  justify-content:center
}
.bill{
  width:650px;
  background:#fff;
  border:2px solid #333;
  padding:20px;
  box-shadow:0 4px 10px rgba(0,0,0,.2)
}
.header{display:flex;gap:20px}
.logo{width:120px;height:120px;border:1px solid #ccc;border-radius:6px}
.logo img{width:100%;height:100%;object-fit:contain}
.shop{text-align:center;flex:1}
.shop h2{margin:0;color:#0073ff;font-size:28px}
hr{border-top:1px dashed #aaa;margin:12px 0}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:8px;font-size:14px}
th{background:#f1f9ff;text-align:left;width:40%}
.summary{
  margin-top:15px;
  display:flex;
  justify-content:space-between;
  background:#f1f9ff;
  padding:10px;
  font-weight:bold
}
.actions{margin-top:15px;display:flex;gap:8px}
.actions button{
  flex:1;
  padding:8px;
  background:#0073ff;
  color:#fff;
  border:none;
  border-radius:4px;
  cursor:pointer
}
.thankyou{
  margin-top:20px;
  background:#2ecc71;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
  border-radius:6px
}
.error{
  color:#b00020;
  text-align:center;
  font-weight:bold;
  margin-top:10px
}
</style>
</head>

<body>

<div class="bill" id="billCard">

<div class="header">
  <div class="logo"><img src="YOUR_LOGO_URL"></div>
  <div class="shop">
    <h2>Siddhivinayak Digital</h2>
    <p>
      Airoli, Navi Mumbai<br>
      üìû 8169040864
    </p>
  </div>
</div>

<hr>

<table>
<tr><th>Bill No</th><td id="billNo">‚Äî</td></tr>
<tr><th>Customer</th><td id="customer">‚Äî</td></tr>
<tr><th>Mobile</th><td id="mobile">‚Äî</td></tr>
<tr><th>Job Description</th><td id="job">‚Äî</td></tr>
<tr><th>Total Amount</th><td id="total">‚Çπ0.00</td></tr>
<tr><th>Advance Paid</th><td id="advance">‚Çπ0.00</td></tr>
<tr><th>Pending Received</th><td id="pendingReceived">‚Çπ0.00</td></tr>
<tr><th>Total Received</th><td id="totalReceived">‚Çπ0.00</td></tr>
<tr><th>Pending Balance</th><td id="pending">‚Çπ0.00</td></tr>
<tr><th>Order Date</th><td id="orderDate">‚Äî</td></tr>
<tr><th>Completed Date</th><td id="completedDate">‚Äî</td></tr>
</table>

<div class="summary">
  <div>Pending: ‚Çπ<span id="pendingSum">0.00</span></div>
  <div>Received: ‚Çπ<span id="receivedSum">0.00</span></div>
</div>

<div class="actions" id="actionBtns">
  <button id="printBtn">Print / PDF</button>
  <button id="downloadBtn">Download PNG</button>
  <button id="shareBtn">Share</button>
</div>

<div class="thankyou">üôè Thank you for choosing Siddhivinayak Digital</div>
<div id="error" class="error" style="display:none"></div>

</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const qs = new URLSearchParams(window.location.search);
const orderCode = qs.get("code");
const errorEl = document.getElementById("error");
const hideBtns = () => actionBtns.style.display="none";
const showBtns = () => actionBtns.style.display="flex";
const money = v => (parseFloat(v)||0).toFixed(2);

if(!orderCode){
  errorEl.textContent="Bill code missing";
  errorEl.style.display="block";
}else{
  loadBill(orderCode);
}

async function loadBill(code){
  const { data, error } = await supabaseClient
    .from("completed_orders")
    .select(`
      order_code,
      customer_name,
      customer_contact,
      job_description,
      total_amount,
      advance_amount,
      pending_received,
      created_at,
      completed_at
    `)
    .eq("order_code", code)
    .single();

  if(error || !data){
    errorEl.textContent="Unable to load bill";
    errorEl.style.display="block";
    return;
  }

  const total = data.total_amount || 0;
  const advance = data.advance_amount || 0;
  const pendingRecv = data.pending_received || 0;
  const received = advance + pendingRecv;
  const pending = Math.max(0, total - received);

  billNo.textContent = data.order_code;
  customer.textContent = data.customer_name;
  mobile.textContent = data.customer_contact;
  job.textContent = data.job_description;

  total.textContent = "‚Çπ"+money(total);
  advance.textContent = "‚Çπ"+money(advance);
  pendingReceived.textContent = "‚Çπ"+money(pendingRecv);
  totalReceived.textContent = "‚Çπ"+money(received);
  pending.textContent = "‚Çπ"+money(pending);

  pendingSum.textContent = money(pending);
  receivedSum.textContent = money(received);

  orderDate.textContent = data.created_at?.split("T")[0] || "";
  completedDate.textContent = data.completed_at?.split("T")[0] || "";
}

/* PRINT */
printBtn.onclick = async ()=>{
  hideBtns(); await new Promise(r=>setTimeout(r,100));
  window.print(); showBtns();
};

/* DOWNLOAD PNG */
downloadBtn.onclick = async ()=>{
  hideBtns();
  const c = await html2canvas(billCard,{scale:2});
  showBtns();
  const a=document.createElement("a");
  a.href=c.toDataURL("image/png");
  a.download="Bill-"+orderCode+".png";
  a.click();
};

/* SHARE PNG */
shareBtn.onclick = async ()=>{
  hideBtns();
  const c = await html2canvas(billCard,{scale:2});
  showBtns();
  c.toBlob(async b=>{
    const f=new File([b],"Bill-"+orderCode+".png",{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[f]})){
      await navigator.share({files:[f]});
    }else{
      const a=document.createElement("a");
      a.href=URL.createObjectURL(b);
      a.download=f.name;
      a.click();
    }
  });
};
</script>

</body>
</html>
