<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Final Bill - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Based on your original simple design */
    body { font-family: "Segoe UI", Arial, sans-serif; background:#f4f6f9; padding:40px; display:flex; justify-content:center; }
    .bill { width:650px; background:#fff; border:2px solid #333; padding:20px; box-shadow:0 4px 10px rgba(0,0,0,.2); position:relative; }
    h2 { text-align:center; color:#0073ff; margin:0 0 8px 0; }
    .address { text-align:center; color:#666; font-size:13px; margin-bottom:12px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#f1f9ff; width:40%; text-align:left; }
    .summaryBox { margin-top:15px; display:flex; justify-content:space-between; background:#f1f9ff; border:1px solid #0073ff; border-radius:6px; padding:10px; font-weight:bold; }
    .thankyou { margin-top:20px; background:#2ecc71; color:#fff; text-align:center; padding:12px; font-weight:bold; border-radius:6px; }
    .shareBtn { margin-top:15px; padding:10px 16px; background:#0073ff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
    .shareBtn:hover { background:#0056b3; }
    .muted { color:#666; font-size:13px; }
    .color-row { display:flex; gap:8px; align-items:center; }
    .color-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:6px; }
    .dot-blue { background:#0073ff; }
    .dot-red { background:#e74c3c; }
    .dot-green { background:#2ecc71; }
    /* PAID stamp */
    .paid-stamp {
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      font-size:96px;
      color: rgba(46, 204, 113, 0.18);
      font-weight:900;
      letter-spacing:6px;
      pointer-events:none;
      display:none;
      z-index: 30;
      text-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .paid-stamp.visible { display:block; }
    @media print {
      .actions, .shareBtn { display:none; }
      .paid-stamp { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="bill" id="billCard">
    <div class="paid-stamp" id="paidStamp">PAID</div>

    <h2>Siddhivinayak Digital</h2>
    <div class="address">Shop No. X, Example Road, Mumbai ‚Ä¢ Phone: 9000000000</div>

    <table>
      <tr><th>Bill No</th><td id="billNo">‚Äî</td></tr>
      <tr><th>Customer Name</th><td id="customer">‚Äî</td></tr>
      <tr><th>Mobile</th><td id="mobile">‚Äî</td></tr>
      <tr><th>Job Description</th><td id="job">‚Äî</td></tr>

      <!-- Color totals (three separate rows) -->
      <tr><th>Blue Total</th><td id="blueTotal">‚Çπ0.00 <span class="color-row"><span class="color-dot dot-blue"></span>Blue</span></td></tr>
      <tr><th>Red Total</th><td id="redTotal">‚Çπ0.00 <span class="color-row"><span class="color-dot dot-red"></span>Red</span></td></tr>
      <tr><th>Green Total</th><td id="greenTotal">‚Çπ0.00 <span class="color-row"><span class="color-dot dot-green"></span>Green</span></td></tr>

      <tr><th>Total Amount</th><td id="total">‚Çπ0.00</td></tr>
      <tr><th>Advance Paid</th><td id="advance">‚Çπ0.00</td></tr>
      <tr><th>Pending Received</th><td id="pendingReceived">‚Çπ0.00</td></tr>
      <tr><th>Total Received</th><td id="totalReceived">‚Çπ0.00</td></tr>
      <tr><th>Total Payable</th><td id="totalPayable">‚Çπ0.00</td></tr>
      <tr><th>Order Date</th><td id="orderDate">‚Äî</td></tr>
      <tr><th>Completed Date</th><td id="completedDate">‚Äî</td></tr>
    </table>

    <div class="summaryBox">
      <div>Pending Balance: ‚Çπ<span id="pendingSum">0.00</span></div>
      <div>Total Received: ‚Çπ<span id="receivedSum">0.00</span></div>
    </div>

    <div class="thankyou">üôè Thank you for choosing Siddhivinayak Digital</div>

    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="shareBtn" id="shareBtn">üì§ Share Bill Image</button>
      <button class="shareBtn" id="printBtn" style="background:#444;">üñ® Print</button>
    </div>

    <div class="muted" id="debugMsg" style="margin-top:12px;"></div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    (function () {
      const $ = id => document.getElementById(id);
      const money = v => (Number(v) || 0).toFixed(2);

      // Wait for supabaseClient to be available
      function whenSupabaseReady(timeout = 3000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();
          (function check() {
            if (typeof supabaseClient !== 'undefined' && supabaseClient) return resolve();
            if (Date.now() - start > timeout) return reject(new Error('supabaseClient not available'));
            setTimeout(check, 50);
          })();
        });
      }

      // Load bill and color totals. Uses DB fields if present:
      // total_amount, advance_amount, pending_received, total_received, pending_balance
      // optional color fields: blue_total, red_total, green_total
      async function loadBill(orderCode) {
        $("debugMsg").textContent = "Loading bill...";
        try {
          const { data, error } = await supabaseClient
            .from("completed_orders")
            .select(`
              order_id,
              order_code,
              customer_name,
              customer_contact,
              job_description,
              total_amount,
              advance_amount,
              pending_received,
              total_received,
              pending_balance,
              blue_total,
              red_total,
              green_total,
              created_at,
              completed_at
            `)
            .eq("order_code", orderCode)
            .limit(1)
            .single();

          if (error) {
            console.error("Supabase error:", error);
            $("debugMsg").textContent = "Bill not found or permission denied. Check console.";
            return;
          }
          if (!data) {
            $("debugMsg").textContent = "No data returned for this code.";
            return;
          }

          // Base amounts
          const dbTotal = Number(data.total_amount ?? 0);
          const advance = Number(data.advance_amount ?? 0);
          const pendingReceived = Number(data.pending_received ?? 0);

          // Color totals from DB if present; fallback to 0
          const blue = Number(data.blue_total ?? 0);
          const red = Number(data.red_total ?? 0);
          const green = Number(data.green_total ?? 0);

          // If color totals sum > 0, prefer that as total amount (keeps design flexible)
          const colorSum = blue + red + green;
          const totalAmount = colorSum > 0 ? colorSum : dbTotal;

          // Prefer DB-derived total_received / pending_balance if present
          const totalReceivedDB = (data.total_received !== null && data.total_received !== undefined) ? Number(data.total_received) : null;
          const pendingBalanceDB = (data.pending_balance !== null && data.pending_balance !== undefined) ? Number(data.pending_balance) : null;

          const totalReceived = totalReceivedDB !== null ? totalReceivedDB : (advance + pendingReceived);
          const payable = pendingBalanceDB !== null ? pendingBalanceDB : Math.max(0, totalAmount - totalReceived);

          // Fill UI
          $("billNo").textContent = data.order_code || "‚Äî";
          $("customer").textContent = data.customer_name || "‚Äî";
          $("mobile").textContent = data.customer_contact || "‚Äî";
          $("job").textContent = data.job_description || "‚Äî";

          $("blueTotal").textContent = "‚Çπ" + money(blue);
          $("redTotal").textContent = "‚Çπ" + money(red);
          $("greenTotal").textContent = "‚Çπ" + money(green);

          $("total").textContent = "‚Çπ" + money(totalAmount);
          $("advance").textContent = "‚Çπ" + money(advance);
          $("pendingReceived").textContent = "‚Çπ" + money(pendingReceived);
          $("totalReceived").textContent = "‚Çπ" + money(totalReceived);
          $("totalPayable").textContent = "‚Çπ" + money(payable);

          $("pendingSum").textContent = money(payable);
          $("receivedSum").textContent = money(totalReceived);

          $("orderDate").textContent = data.created_at ? new Date(data.created_at).toLocaleDateString() : "‚Äî";
          $("completedDate").textContent = data.completed_at ? new Date(data.completed_at).toLocaleDateString() : "‚Äî";

          // Show PAID stamp if payable is 0 (or effectively zero)
          const paidStamp = $("paidStamp");
          if (Number(payable) <= 0.0001) {
            paidStamp.classList.add("visible");
          } else {
            paidStamp.classList.remove("visible");
          }

          $("debugMsg").textContent = "";
        } catch (err) {
          console.error("loadBill exception:", err);
          $("debugMsg").textContent = "Error loading bill. See console for details.";
        }
      }

      // Share bill as image using html2canvas
      async function shareBillImage() {
        const node = $("billCard");
        if (!node) return alert("Bill container not found.");

        try {
          const canvas = await html2canvas(node, { scale: 2, useCORS: true });
          const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png", 0.95));
          if (!blob) throw new Error("Failed to create image blob.");

          const file = new File([blob], `${(window.__ORDER_CODE__ || 'bill')}.png`, { type: "image/png" });

          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: `Bill ${window.__ORDER_CODE__ || ''}`,
              text: `Final bill ${window.__ORDER_CODE__ || ''}`,
              files: [file]
            });
            return;
          }

          const url = URL.createObjectURL(blob);
          const win = window.open(url, "_blank");
          if (!win) {
            const a = document.createElement("a");
            a.href = url;
            a.download = `${(window.__ORDER_CODE__ || 'bill')}.png`;
            document.body.appendChild(a);
            a.click();
            a.remove();
          }
        } catch (err) {
          console.error("shareBillImage error:", err);
          alert("Unable to share image. See console for details.");
        }
      }

      // Print
      $("printBtn").addEventListener("click", () => window.print());
      $("shareBtn").addEventListener("click", shareBillImage);

      // Init
      (async function init() {
        const params = new URLSearchParams(window.location.search);
        const raw = params.get("code") || params.get("order_code") || params.get("id");
        const code = raw ? decodeURIComponent(raw).trim() : null;
        if (!code) {
          $("debugMsg").textContent = "No order code provided in URL. Use ?code=SD/001";
          return;
        }
        window.__ORDER_CODE__ = code;

        try {
          await whenSupabaseReady(3000);
          await loadBill(code);
        } catch (err) {
          console.error("Supabase init error:", err);
          $("debugMsg").textContent = "Supabase client not initialized. Ensure js/supabase-config.js is loaded and defines supabaseClient.";
        }
      })();
    })();
  </script>
</body>
</html>
