<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Orders Queue</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f4f6f9; }
    header { background:#34495e; color:#fff; padding:18px; text-align:center; }
    .container { padding:20px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    input, select { padding:6px; border:1px solid #ccc; border-radius:4px; }
    .btn { padding:8px 12px; background:#e74c3c; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .btn:hover { background:#c0392b; }
    #toast { display:none; position:fixed; bottom:20px; right:20px; background:#27ae60; color:#fff; padding:10px 14px; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Orders Queue</h1>
    <div id="welcome"></div>
  </header>

  <div class="container">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Token</th>
          <th>Customer</th>
          <th>Job Description</th>
          <th>TAT</th>
          <th>Status</th>
          <th>Assigned To</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <br>
    <button id="logout" class="btn">Logout</button>
  </div>

  <div id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://qcyqjcxzytjtsikzrdyv.supabase.co";
    const supabaseKey = "YOUR-ANON-KEY-HERE"; // replace with your anon key
    const { createClient } = supabase;
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    const name = localStorage.getItem("displayName") || "Staff";
    const uid = localStorage.getItem("uid") || "";
    document.getElementById("welcome").textContent = `Welcome, ${name} (UID: ${uid})`;

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 2500);
    }

    async function loadOrders() {
      const { data: orders, error } = await supabaseClient
        .from("orders")
        .select("order_id, customer_name, job_description, tat, order_token, status, assigned_to")
        .order("created_at", { ascending: false });

      if (error) { console.error(error); return; }

      const tbody = document.querySelector("#ordersTable tbody");
      tbody.innerHTML = "";

      // Load staff list for assignment dropdown
      const { data: staff } = await supabaseClient
        .from("profiles")
        .select("id, email, role, display_name");

      orders.forEach(order => {
        const tr = document.createElement("tr");

        // Token
        tr.innerHTML = `<td>${order.order_token || "-"}</td>
                        <td>${order.customer_name || "-"}</td>`;

        // Job description (editable)
        const jobTd = document.createElement("td");
        const jobInput = document.createElement("input");
        jobInput.value = order.job_description || "";
        jobInput.addEventListener("change", async () => {
          await supabaseClient.from("orders")
            .update({ job_description: jobInput.value })
            .eq("order_id", order.order_id);
          showToast("Job updated");
        });
        jobTd.appendChild(jobInput);
        tr.appendChild(jobTd);

        // TAT (editable)
        const tatTd = document.createElement("td");
        const tatInput = document.createElement("input");
        tatInput.value = order.tat || "";
        tatInput.placeholder = "e.g. 2 hours";
        tatInput.addEventListener("change", async () => {
          await supabaseClient.from("orders")
            .update({ tat: tatInput.value })
            .eq("order_id", order.order_id);
          showToast("TAT updated");
        });
        tatTd.appendChild(tatInput);
        tr.appendChild(tatTd);

        // Status dropdown
        const statusTd = document.createElement("td");
        const statusSelect = document.createElement("select");
        ["Hold","In Process","Pending","Completed"].forEach(s => {
          const opt = document.createElement("option");
          opt.value = s; opt.textContent = s;
          if (order.status === s) opt.selected = true;
          statusSelect.appendChild(opt);
        });
        statusSelect.addEventListener("change", async () => {
          await supabaseClient.from("orders")
            .update({ status: statusSelect.value })
            .eq("order_id", order.order_id);
          showToast("Status updated");
        });
        statusTd.appendChild(statusSelect);
        tr.appendChild(statusTd);

        // Assigned staff dropdown
        const assignTd = document.createElement("td");
        const assignSelect = document.createElement("select");
        staff.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = `${u.display_name || u.email} (${u.id})`;
          if (order.assigned_to === u.id) opt.selected = true;
          assignSelect.appendChild(opt);
        });
        assignSelect.addEventListener("change", async () => {
          await supabaseClient.from("orders")
            .update({ assigned_to: assignSelect.value })
            .eq("order_id", order.order_id);
          showToast("Assigned staff updated");
        });
        assignTd.appendChild(assignSelect);
        tr.appendChild(assignTd);

        tbody.appendChild(tr);
      });
    }

    loadOrders();

    document.getElementById("logout").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      localStorage.clear();
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
