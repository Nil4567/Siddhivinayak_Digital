<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Orders Queue - Siddhivinayak Digital</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:20px; }
    header { display:flex; justify-content:space-between; align-items:center; background:#2c3e50; color:#fff; padding:15px; border-radius:6px; }
    .clock { font-weight:bold; }
    .buttons button { margin-left:10px; padding:8px 16px; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
    .btn-back { background:#0073ff; color:#fff; }
    .btn-logout { background:#e74c3c; color:#fff; }
    h1 { margin-top:20px; color:#2c3e50; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    th, td { padding:10px; border:1px solid #ddd; text-align:left; }
    th { background:#2c3e50; color:#fff; }
    button.complete { padding:6px 12px; background:#27ae60; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button.complete:hover { background:#219150; }
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem("loggedIn") !== "yes") {
      window.location.href = "home.html";
    }
  </script>

  <header>
    <div class="clock" id="clock"></div>
    <div class="buttons">
      <button class="btn-back" onclick="window.history.back()">Back</button>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <h1>Orders Queue</h1>

  <table id="queueTable">
    <tr>
      <th>Order Code</th>
      <th>Customer</th>
      <th>Job</th>
      <th>Total</th>
      <th>Advance</th>
      <th>Pending</th>
      <th>Action</th>
    </tr>
  </table>

  <!-- Supabase library + config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Clock
      function updateClock() {
        const now = new Date();
        document.getElementById("clock").textContent = now.toLocaleDateString() + " " + now.toLocaleTimeString();
      }
      setInterval(updateClock, 1000); updateClock();

      function logout() {
        localStorage.clear();
        window.location.href = "home.html";
      }
      window.logout = logout;

      // Load queue orders
      async function loadQueue() {
        const { data, error } = await supabaseClient
          .from("orders")
          .select("*")
          .eq("status", "In Process");

        if (error) {
          alert("Error loading queue: " + error.message);
          return;
        }

        const table = document.getElementById("queueTable");
        data.forEach(order => {
          const row = table.insertRow();
          row.insertCell().innerText = order.order_code;
          row.insertCell().innerText = order.customer_name;
          row.insertCell().innerText = order.job_description;
          row.insertCell().innerText = order.total_amount;
          row.insertCell().innerText = order.advance_amount;
          row.insertCell().innerText = order.pending_amount;

          const actionCell = row.insertCell();
          const btn = document.createElement("button");
          btn.className = "complete";
          btn.innerText = "Complete";
          btn.onclick = () => completeOrder(order.order_id);
          actionCell.appendChild(btn);
        });
      }

      // Mark order as completed
      async function completeOrder(orderId) {
        const { error } = await supabaseClient
          .from("orders")
          .update({ status: "Completed" })
          .eq("order_id", orderId);

        if (error) {
          alert("Error completing order: " + error.message);
        } else {
          alert("Order marked as Completed!");
          location.reload();
        }
      }

      loadQueue();
    });
  </script>
</body>
</html>
