<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Completed Orders - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#2ecc71; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    .nav { background:#fff; color:#2ecc71; border:none; padding:8px 14px; margin-left:10px; border-radius:4px; cursor:pointer; font-weight:600; }
    .nav:hover { background:#e6ffe6; }
    .branding { text-align:center; margin:20px 0; }
    .branding h2 { margin:0; color:#2c3e50; }
    .branding p { margin:4px 0; color:#555; }
    .filters { text-align:center; margin:20px; }
    .filters input { padding:6px; margin:0 5px; border:1px solid #ccc; border-radius:4px; }
    .filters button { padding:8px 14px; background:#2ecc71; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
    .filters button:hover { background:#27ae60; }
    .summary { display:flex; justify-content:center; gap:20px; margin:20px; }
    .box { padding:12px 20px; border-radius:6px; color:#fff; font-weight:bold; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
    .amount { background:#3498db; }
    .count { background:#9b59b6; }
    table { width:95%; margin:auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; vertical-align:top; }
    th { background:#2ecc71; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>Siddhivinayak Digital</h1>
    <div>
      <button class="nav" id="homeBtn">Home</button>
      <button class="nav" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="branding">
    <h2>Completed Orders</h2>
    <p>Shop No. 12, Main Road, Mumbai</p>
  </div>

  <div class="filters">
    <label>From: <input type="date" id="startDate"></label>
    <label>To: <input type="date" id="endDate"></label>
    <button onclick="loadCompleted()">Filter</button>
  </div>

  <div class="summary">
    <div class="box amount" id="totalPaid">Total Paid: ₹0</div>
    <div class="box count" id="completedCount">Completed Orders: 0</div>
  </div>

  <table id="completedTable">
    <thead>
      <tr>
        <th>Order Code</th>
        <th>Customer</th>
        <th>Mobile</th>
        <th>Job Description</th>
        <th>Total</th>
        <th>Advance</th>
        <th>Pending</th>
        <th>Order Date</th>
        <th>Completed Date</th>
        <th>TAT (Days)</th>
        <th>Assigned To</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    let users = [];
    let currentData = [];

    // Home + Logout
    document.getElementById("homeBtn").addEventListener("click", () => {
      const role = localStorage.getItem("role");
      window.location.href = role === "admin" ? "admin-dashboard.html" : "user-home.html";
    });
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try { if (supabaseClient && supabaseClient.auth) await supabaseClient.auth.signOut(); } catch(_) {}
      localStorage.clear();
      window.location.href = "login.html";
    });

    async function loadUsers() {
      const { data } = await supabaseClient.from("profiles").select("id, display_name");
      users = data || [];
    }

    async function loadCompleted() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;

      let query = supabaseClient
        .from("orders")
        .select("order_code, customer_name, customer_contact, job_description, total_amount, advance_amount, pending_amount, assigned_to, created_at, completed_at")
        .eq("status","Completed");

      if (start) query = query.gte("completed_at", start);
      if (end) query = query.lte("completed_at", end);

      const { data, error } = await query;
      if (error) { alert("Error loading completed orders: " + error.message); return; }

      currentData = data || [];
      let totalPaid = 0;
      currentData.forEach(o => { totalPaid += (o.total_amount ?? 0) - (o.pending_amount ?? 0); });
      document.getElementById("totalPaid").textContent = "Total Paid: ₹" + totalPaid.toFixed(2);
      document.getElementById("completedCount").textContent = "Completed Orders: " + currentData.length;

      const tbody = document.querySelector("#completedTable tbody");
      tbody.innerHTML = "";
      currentData.forEach(order => {
        const orderDate = new Date(order.created_at);
        const completedDate = new Date(order.completed_at);
        const tatDays = Math.floor((completedDate - orderDate) / (1000*60*60*24));
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${order.order_code}</td>
          <td>${order.customer_name}</td>
          <td>${order.customer_contact || ""}</td>
          <td>${order.job_description}</td>
          <td>${order.total_amount ?? 0}</td>
          <td>${order.advance_amount ?? 0}</td>
          <td>${order.pending_amount ?? 0}</td>
          <td>${orderDate.toISOString().split("T")[0]}</td>
          <td>${order.completed_at ? completedDate.toISOString().split("T")[0] : ""}</td>
          <td>${isNaN(tatDays) ? "" : tatDays}</td>
          <td>${users.find(u=>u.id===order.assigned_to)?.display_name || "Unassigned"}</td>
        `;
        tbody.appendChild(row);
      });
    }

    (async function init(){
      await loadUsers();
      await loadCompleted();
    })();
  </script>
</body>
</html>
