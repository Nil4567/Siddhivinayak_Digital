<script>
  let users = [];
  let currentData = [];

  // Home + Logout
  document.getElementById("homeBtn").addEventListener("click", () => {
    const role = localStorage.getItem("role");
    window.location.href = role === "admin" ? "admin-dashboard.html" : "user-home.html";
  });
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    try { if (supabaseClient && supabaseClient.auth) await supabaseClient.auth.signOut(); } catch(_) {}
    localStorage.clear();
    window.location.href = "login.html";
  });

  async function loadUsers() {
    const { data } = await supabaseClient.from("profiles").select("id, display_name");
    users = data || [];
  }

  async function loadCompleted() {
    // Default last 30 days
    const today = new Date();
    const past30 = new Date();
    past30.setDate(today.getDate() - 30);

    const start = document.getElementById("startDate").value || past30.toISOString().split("T")[0];
    const end = document.getElementById("endDate").value || today.toISOString().split("T")[0];

    let query = supabaseClient
      .from("orders")
      .select("order_code, customer_name, customer_contact, job_description, total_amount, advance_amount, pending_amount, assigned_to, created_at, completed_at")
      .eq("status","Completed")
      .gte("completed_at", start)
      .lte("completed_at", end);

    const { data, error } = await query;
    if (error) { alert("Error loading completed orders: " + error.message); return; }

    currentData = data || [];
    let totalPaid = 0;
    currentData.forEach(o => { totalPaid += (o.total_amount ?? 0) - (o.pending_amount ?? 0); });
    document.getElementById("totalPaid").textContent = "Total Paid: â‚¹" + totalPaid.toFixed(2);
    document.getElementById("completedCount").textContent = "Completed Orders: " + currentData.length;

    const tbody = document.querySelector("#completedTable tbody");
    tbody.innerHTML = "";
    currentData.forEach(order => {
      const orderDate = new Date(order.created_at);
      const completedDate = new Date(order.completed_at);
      const tatDays = Math.floor((completedDate - orderDate) / (1000*60*60*24));
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${order.order_code}</td>
        <td>${order.customer_name}</td>
        <td>${order.customer_contact || ""}</td>
        <td>${order.job_description}</td>
        <td>${order.total_amount ?? 0}</td>
        <td>${order.advance_amount ?? 0}</td>
        <td>${order.pending_amount ?? 0}</td>
        <td>${orderDate.toISOString().split("T")[0]}</td>
        <td>${order.completed_at ? completedDate.toISOString().split("T")[0] : ""}</td>
        <td>${isNaN(tatDays) ? "" : tatDays}</td>
        <td>${users.find(u=>u.id===order.assigned_to)?.display_name || "Unassigned"}</td>
      `;
      tbody.appendChild(row);
    });
  }

  (async function init(){
    await loadUsers();
    await loadCompleted();
  })();
</script>
