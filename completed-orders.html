<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Completed Orders - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#2ecc71; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    .nav { background:#fff; color:#2ecc71; border:none; padding:8px 14px; margin-left:10px; border-radius:4px; cursor:pointer; font-weight:600; }
    .nav:hover { background:#e6ffe6; }
    .branding { text-align:center; margin:20px 0; }
    .branding h2 { margin:0; color:#2c3e50; }
    .filters { text-align:center; margin:20px; }
    .filters h3 { margin-bottom:10px; color:#2c3e50; }
    .filters input { padding:6px; margin:0 5px; border:1px solid #ccc; border-radius:4px; }
    .filters button { padding:8px 14px; background:#2ecc71; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
    .filters button:hover { background:#27ae60; }
    .summary { display:flex; justify-content:center; gap:20px; margin:20px; flex-wrap:wrap; }
    .box { padding:12px 20px; border-radius:6px; color:#fff; font-weight:bold; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
    .amount { background:#3498db; }
    .pending { background:#e67e22; }
    .count { background:#9b59b6; }
    table { width:95%; margin:auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; vertical-align:top; }
    th { background:#2ecc71; color:#fff; }
    input.pendingInput { width:90px; padding:4px; }
    button.updatePendingBtn { background:#f39c12; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-right:6px; }
    button.updatePendingBtn:hover { background:#e67e22; }
    button.tokenBtn { background:#3498db; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
    button.tokenBtn:hover { background:#2980b9; }
  </style>
</head>
<body>
  <header>
    <h1>Siddhivinayak Digital</h1>
    <div>
      <button class="nav" id="homeBtn">Home</button>
      <button class="nav" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="branding">
    <h2>Completed Orders</h2>
  </div>

  <div class="filters">
    <h3>Filter Completed Orders</h3>
    <label>From: <input type="date" id="startDate"></label>
    <button id="applyFilterBtn">Apply Filter</button>
  </div>

  <div class="summary">
    <div class="box amount" id="totalPaid">Total Paid: ₹0</div>
    <div class="box pending" id="pendingTotal">Total Pending: ₹0</div>
    <div class="box count" id="completedCount">Completed Orders: 0</div>
  </div>

  <table id="completedTable">
    <thead>
      <tr>
        <th>Order Code</th>
        <th>Customer</th>
        <th>Mobile</th>
        <th>Job Description</th>
        <th>Total</th>
        <th>Advance</th>
        <th>Pending</th>
        <th>Order Date</th>
        <th>Completed Date</th>
        <th>TAT (Days)</th>
        <th>Assigned To</th>
        <th>Pending Received</th>
        <th>Total Received</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    let users = [];

    // Navigation
    document.getElementById("homeBtn").addEventListener("click", () => {
      const role = localStorage.getItem("role");
      window.location.href = role === "admin" ? "admin-dashboard.html" : "user-home.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try { if (supabaseClient && supabaseClient.auth) await supabaseClient.auth.signOut(); } catch(_) {}
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Load users for assigned_to display_name
    async function loadUsers() {
      const { data, error } = await supabaseClient.from("profiles").select("id, display_name");
      if (error) { console.error("Error loading users:", error.message); }
      users = data || [];
    }

    // Load completed orders with optional From date
    async function loadCompleted() {
      const start = document.getElementById("startDate").value;

      let query = supabaseClient
        .from("completed_orders")
        .select("order_id, order_code, customer_name, customer_contact, job_description, total_amount, advance_amount, pending_amount, pending_received, assigned_to, created_at, completed_at");

      if (start) {
        // Show only orders completed on or after From date
        query = query.gte("completed_at", start);
      }

      const { data, error } = await query.order("completed_at", { ascending: false });
      if (error) { alert("Error loading completed orders: " + error.message); return; }

      const rows = data || [];
      // Summary totals
      let totalPaid = 0;
      let totalPending = 0;
      rows.forEach(o => { 
        const adv = o.advance_amount ?? 0;
        const pendRecv = o.pending_received ?? 0;
        const pendAmt = o.pending_amount ?? 0;
        totalPaid += adv + pendRecv;
        totalPending += Math.max(0, pendAmt - pendRecv);
      });
      document.getElementById("totalPaid").textContent = "Total Paid: ₹" + totalPaid.toFixed(2);
      document.getElementById("pendingTotal").textContent = "Total Pending: ₹" + totalPending.toFixed(2);
      document.getElementById("completedCount").textContent = "Completed Orders: " + rows.length;

      // Render table
      const tbody = document.querySelector("#completedTable tbody");
      tbody.innerHTML = "";
      rows.forEach(order => {
        const orderDate = new Date(order.created_at);
        const completedDate = order.completed_at ? new Date(order.completed_at) : null;
        const tatDays = completedDate ? Math.floor((completedDate - orderDate) / (1000*60*60*24)) : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${order.order_code || ""}</td>
          <td>${order.customer_name || ""}</td>
          <td>${order.customer_contact || ""}</td>
          <td>${order.job_description || ""}</td>
          <td>${(order.total_amount ?? 0).toFixed(2)}</td>
          <td>${(order.advance_amount ?? 0).toFixed(2)}</td>
          <td>${(order.pending_amount ?? 0).toFixed(2)}</td>
          <td>${orderDate.toISOString().split("T")[0]}</td>
          <td>${completedDate ? completedDate.toISOString().split("T")[0] : ""}</td>
          <td>${tatDays}</td>
          <td>${users.find(u=>u.id===order.assigned_to)?.display_name || "Unassigned"}</td>
          <td>
            <input type="number" min="0" step="0.01" value="${order.pending_received ?? 0}"
                   class="pendingInput" data-id="${order.order_id}">
          </td>
          <td>${((order.advance_amount ?? 0) + (order.pending_received ?? 0)).toFixed(2)}</td>
          <td>
            <button class="updatePendingBtn" data-id="${order.order_id}">Update Pending</button>
            <button class="tokenBtn" data-code="${order.order_code || ''}">Bill Token</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      attachPendingEvents();
      attachTokenEvents();
    }

    // Update pending_received per row
    function attachPendingEvents() {
      document.querySelectorAll(".updatePendingBtn").forEach(btn => {
        btn.addEventListener("click", async function() {
          const id = this.getAttribute("data-id");
          const input = document.querySelector(`.pendingInput[data-id="${id}"]`);
          const amount = parseFloat(input.value);
          const sanitized = isNaN(amount) || amount < 0 ? 0 : amount;

          const { error } = await supabaseClient
            .from("completed_orders")
            .update({ pending_received: sanitized })
            .eq("order_id", id);

          if (error) {
            alert("Error updating pending: " + error.message);
          } else {
            alert("Pending updated successfully!");
            await loadCompleted(); // reload to update Total Received and summary tabs
          }
        });
      });
    }

    // Open bill token for the given order_code
    function attachTokenEvents() {
      document.querySelectorAll(".tokenBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const code = btn.getAttribute("data-code");
          const url = "bill-token.html?code=" + encodeURIComponent(code || "");
          window.open(url, "_blank");
        });
      });
    }

    // Initialize: set From date default to first day of current month for convenience
    function setDefaultStartDate() {
      const d = new Date();
      const first = new Date(d.getFullYear(), d.getMonth(), 1);
      document.getElementById("startDate").value = first.toISOString().split("T")[0];
    }

    document.getElementById("applyFilterBtn").addEventListener("click", loadCompleted);

    (async function init(){
      setDefaultStartDate();
      await loadUsers();
      await loadCompleted();
    })();
  </script>
</body>
</html>
