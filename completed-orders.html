<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Completed Orders - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#2ecc71; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    .nav { background:#fff; color:#2ecc71; border:none; padding:8px 14px; margin-left:10px; border-radius:4px; cursor:pointer; font-weight:600; }
    .branding { text-align:center; margin:20px 0; }
    .branding h2 { margin:0; color:#2c3e50; }
    .summary { display:flex; justify-content:center; gap:20px; margin:20px; flex-wrap:wrap; }
    .box { padding:12px 20px; border-radius:6px; color:#fff; font-weight:bold; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
    .amount { background:#3498db; }
    .pending { background:#e67e22; }
    .count { background:#9b59b6; }
    table { width:95%; margin:auto; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    th, td { border:1px solid #ddd; padding:10px; text-align:left; vertical-align:top; }
    th { background:#2ecc71; color:#fff; }
    input.pendingInput { width:90px; padding:4px; margin-right:6px; }
    button.updatePendingBtn { background:#f39c12; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; margin-right:6px; }
    button.tokenBtn { background:#3498db; color:#fff; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
    .thankyou { margin-top:20px; background:#2ecc71; color:#fff; text-align:center; padding:12px; font-weight:bold; border-radius:6px; }
    .small { font-size:12px; color:#666; text-align:center; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>
    <h1>Siddhivinayak Digital</h1>
    <div>
      <button class="nav" id="homeBtn">Home</button>
      <button class="nav" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="branding">
    <h2>Completed Orders</h2>
    <div class="small">Use the Update Pending button to save pending_received. Table refreshes automatically.</div>
  </div>

  <div class="summary">
    <div class="box amount" id="totalPaid">Total Paid: ‚Çπ0</div>
    <div class="box pending" id="pendingTotal">Total Pending: ‚Çπ0</div>
    <div class="box count" id="completedCount">Completed Orders: 0</div>
  </div>

  <table id="completedTable">
    <thead>
      <tr>
        <th>Order Code</th>
        <th>Customer</th>
        <th>Mobile</th>
        <th>Job Description</th>
        <th>Total</th>
        <th>Advance</th>
        <th>Pending</th>
        <th>Order Date</th>
        <th>Completed Date</th>
        <th>Total Received</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="thankyou">üôè Thank you for choosing Siddhivinayak Digital</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    // Navigation
    document.getElementById("homeBtn").addEventListener("click", () => {
      const role = localStorage.getItem("role");
      window.location.href = role === "admin" ? "admin-dashboard.html" : "user-home.html";
    });
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try { if (supabaseClient && supabaseClient.auth) await supabaseClient.auth.signOut(); } catch(_) {}
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Load completed orders from Supabase
    async function loadCompleted() {
      try {
        const { data, error } = await supabaseClient
          .from("completed_orders")
          .select("order_code, customer_name, customer_contact, job_description, total_amount, advance_amount, pending_amount, pending_received, created_at, completed_at")
          .order("completed_at", { ascending: false });

        if (error) {
          console.error("Error loading completed orders:", error);
          alert("Error loading completed orders: " + error.message);
          return;
        }
        renderCompleted(data || []);
        recalcSummary();
      } catch (err) {
        console.error("loadCompleted exception:", err);
        alert("Unexpected error loading completed orders.");
      }
    }

    // Render table rows
    function renderCompleted(rows) {
      const tbody = document.querySelector("#completedTable tbody");
      tbody.innerHTML = "";
      rows.forEach(order => {
        const totalAmt = parseFloat(order.total_amount || 0);
        const advAmt = parseFloat(order.advance_amount || 0);
        const pendAmt = parseFloat(order.pending_amount || 0);
        const pendRecv = parseFloat(order.pending_received || 0);
        const totalReceived = advAmt + pendRecv;
        const pendingBalance = Math.max(0, totalAmt - totalReceived);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(order.order_code || "")}</td>
          <td>${escapeHtml(order.customer_name || "")}</td>
          <td>${escapeHtml(order.customer_contact || "")}</td>
          <td>${escapeHtml(order.job_description || "")}</td>
          <td>‚Çπ${totalAmt.toFixed(2)}</td>
          <td>‚Çπ${advAmt.toFixed(2)}</td>
          <td>‚Çπ${pendAmt.toFixed(2)}</td>
          <td>${order.created_at ? new Date(order.created_at).toLocaleDateString() : ""}</td>
          <td>${order.completed_at ? new Date(order.completed_at).toLocaleDateString() : ""}</td>
          <td>‚Çπ${totalReceived.toFixed(2)}</td>
          <td>
            <input type="number" min="0" step="0.01" value="${pendRecv.toFixed(2)}" class="pendingInput" data-code="${escapeHtml(order.order_code || "")}">
            <button class="updatePendingBtn" data-code="${escapeHtml(order.order_code || "")}">Update Pending</button>
            <button class="tokenBtn" data-code="${encodeURIComponent(order.order_code || "")}">Bill</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      attachPendingEvents();
      attachTokenEvents();
    }

    // Escape helper
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // Attach pending update events (uses order_code for reliable updates)
    function attachPendingEvents() {
      document.querySelectorAll(".updatePendingBtn").forEach(btn => {
        btn.addEventListener("click", async function() {
          const code = this.getAttribute("data-code");
          const input = document.querySelector(`.pendingInput[data-code="${code}"]`);
          if (!input) return alert("Input not found for this order.");
          const amount = parseFloat(input.value);
          const sanitized = isNaN(amount) || amount < 0 ? 0 : amount;

          try {
            const { error } = await supabaseClient
              .from("completed_orders")
              .update({ pending_received: sanitized })
              .eq("order_code", code);

            if (error) {
              console.error("Update error:", error);
              alert("Error updating pending: " + error.message);
            } else {
              // Refresh from server to ensure persisted value is shown
              await loadCompleted();
              alert("Pending updated successfully!");
            }
          } catch (err) {
            console.error("Exception updating pending:", err);
            alert("Unexpected error while updating pending.");
          }
        });
      });
    }

    // Attach token (final bill) events
    function attachTokenEvents() {
      document.querySelectorAll(".tokenBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const code = decodeURIComponent(btn.getAttribute("data-code") || "");
          // open final bill with order_code param (consistent)
          window.open(`final-bill.html?order_code=${encodeURIComponent(code)}`, "_blank");
        });
      });
    }

    // Recalculate summary totals based on visible rows
    function recalcSummary() {
      let totalPaid = 0, totalPending = 0, count = 0;
      const rows = document.querySelectorAll("#completedTable tbody tr");
      rows.forEach(row => {
        // If row hidden by any future filters, skip (keeps compatibility)
        if (row.style.display === "none") return;
        count++;
        const totalText = row.children[4].textContent.replace("‚Çπ","").trim();
        const advText = row.children[5].textContent.replace("‚Çπ","").trim();
        const total = parseFloat(totalText) || 0;
        const adv = parseFloat(advText) || 0;
        const pendRecvInput = row.querySelector(".pendingInput");
        const pendRecv = pendRecvInput ? (parseFloat(pendRecvInput.value) || 0) : 0;
        const totalReceived = adv + pendRecv;
        const pendingBalance = Math.max(0, total - totalReceived);
        totalPaid += totalReceived;
        totalPending += pendingBalance;
      });

      document.getElementById("totalPaid").textContent = "Total Paid: ‚Çπ" + totalPaid.toFixed(2);
      document.getElementById("pendingTotal").textContent = "Total Pending: ‚Çπ" + totalPending.toFixed(2);
      document.getElementById("completedCount").textContent = "Completed Orders: " + count;
    }

    // Init: load table
    (async function init() {
      // Ensure supabaseClient is available
      if (typeof supabaseClient === "undefined") {
        alert("supabaseClient not found. Make sure js/supabase-config.js defines supabaseClient.");
        return;
      }
      await loadCompleted();

      // Optional: recalc summary when user edits pending input manually (before pressing Update)
      document.addEventListener("input", (e) => {
        if (e.target && e.target.classList && e.target.classList.contains("pendingInput")) {
          recalcSummary();
        }
      });
    })();
  </script>
</body>
</html>
