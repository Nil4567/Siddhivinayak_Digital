<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;

  // ✅ Your Supabase project details
  const supabaseUrl = "https://qcyqjcxzytjtsikzrdyv.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeXFqY3h6eXRqdHNpa3pyZHl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzA4NjAsImV4cCI6MjA4MDgwNjg2MH0.q0gkhSgqT_BNfsZBCd2stkgskf2V-CDVIG9p6S5LHdM";
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  // Toast helper
  function showToast(msg, type = "success") {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.style.background = type === "error" ? "#e74c3c" : "#27ae60";
    toast.style.color = "#fff";
    toast.style.padding = "8px 12px";
    toast.style.borderRadius = "4px";
    toast.style.display = "block";
    setTimeout(() => toast.style.display = "none", 2500);
  }

  // Load orders into queue
  async function loadOrders() {
    const { data, error } = await supabaseClient
      .from("orders")
      .select("*")
      .order("order_id", { ascending: true });

    if (error) {
      console.error(error);
      showToast("Error loading orders", "error");
      return;
    }

    const tbody = document.getElementById("orders-body");
    tbody.innerHTML = "";
    data.forEach(o => {
      const pending = o.pending_amount ?? (o.total_amount - (o.advance_amount || 0));
      tbody.innerHTML += `
        <tr>
          <td>${o.order_id}</td>
          <td>${o.cust_name}</td>
          <td>${o.job_description}</td>
          <td>₹${Number(o.total_amount).toFixed(2)}</td>
        </tr>`;
    });
  }

  // Save new order
  document.getElementById("order-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const cust_name = document.getElementById("cust_name").value.trim();
    const job_description = document.getElementById("job_description").value.trim();
    const total_amount = parseFloat(document.getElementById("total_amount").value) || 0;

    if (!cust_name || !job_description || total_amount <= 0) {
      showToast("Please fill required fields", "error");
      return;
    }

    // Get logged-in user
    const { data: userData } = await supabaseClient.auth.getUser();
    const user = userData?.user;

    const { error } = await supabaseClient.from("orders").insert([{
      cust_name,
      job_description,
      total_amount,
      advance_amount: 0, // default
      assigned_to: user ? user.id : null,
      created_by: user ? user.id : null
    }]);

    if (error) {
      console.error(error);
      showToast("Error saving order", "error");
    } else {
      showToast("Order submitted", "success");
      e.target.reset();
      loadOrders(); // refresh queue immediately
    }
  });

  // Initialize
  document.addEventListener("DOMContentLoaded", async () => {
    loadOrders();
  });
</script>
