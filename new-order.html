<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Create New Order - Siddhivinayak Digital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f9; margin:0; padding:0; }
    header { background:#0073ff; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    .nav { background:#fff; color:#0073ff; border:none; padding:8px 14px; margin-left:10px; border-radius:4px; cursor:pointer; font-weight:600; }
    .nav:hover { background:#e6f0ff; }
    .branding { text-align:center; margin:20px 0; }
    .branding h2 { margin:0; color:#2c3e50; }
    .branding p { margin:4px 0; color:#555; }

    form { background:#fff; padding:20px; border-radius:8px; max-width:600px; margin:20px auto; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    label { display:block; margin-top:12px; font-weight:bold; color:#2c3e50; }
    input, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    input[readonly] { background:#eee; }
    button.submitBtn { margin-top:20px; padding:12px 20px; background:#0073ff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; width:100%; font-size:16px; }
    button.submitBtn:hover { background:#0056b3; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>Siddhivinayak Digital</h1>
    <div>
      <button class="nav" id="homeBtn">Home</button>
      <button class="nav" id="logoutBtn">Logout</button>
    </div>
  </header>

  <!-- Branding -->
  <div class="branding">
    <h2>Create New Order</h2>
    <p> OM Namah Shivay </p>
  </div>

  <!-- Order Form -->
  <form id="orderForm">
    <label>Customer Name *</label>
    <input type="text" id="custName" required />

    <label>Customer Contact</label>
    <input type="text" id="custMobile" />

    <label>Job Description *</label>
    <textarea id="jobDesc" required></textarea>

    <label>Total Amount</label>
    <input type="number" id="totalAmount" step="0.01" />

    <label>Advance Amount</label>
    <input type="number" id="advanceAmount" step="0.01" />

    <label>Pending Amount</label>
    <input type="number" id="pendingAmount" readonly />

    <label>Order Date</label>
    <input type="date" id="orderDate" />

    <button type="submit" class="submitBtn">Submit Order</button>
  </form>

  <!-- Supabase SDK + Config -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>

  <script>
    // Auto-populate order date with today's date
    document.getElementById("orderDate").value = new Date().toISOString().split("T")[0];

    // Calculate pending amount live
    function updatePending() {
      const total = parseFloat(document.getElementById("totalAmount").value) || 0;
      const advance = parseFloat(document.getElementById("advanceAmount").value) || 0;
      document.getElementById("pendingAmount").value = (total - advance).toFixed(2);
    }
    document.getElementById("totalAmount").addEventListener("input", updatePending);
    document.getElementById("advanceAmount").addEventListener("input", updatePending);

    // Home + Logout buttons
    document.getElementById("homeBtn").addEventListener("click", () => {
      const role = localStorage.getItem("role");
      if (role === "admin") {
        window.location.href = "admin-dashboard.html";
      } else {
        window.location.href = "user-home.html";
      }
    });
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        if (supabaseClient && supabaseClient.auth) {
          await supabaseClient.auth.signOut().catch(() => {});
        }
      } catch (_) {}
      localStorage.clear();
      window.location.href = "login.html";
    });

    // Submit order
    document.getElementById("orderForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const order = {
        customer_name: document.getElementById("custName").value,
        customer_contact: document.getElementById("custMobile").value,
        job_description: document.getElementById("jobDesc").value,
        total_amount: parseFloat(document.getElementById("totalAmount").value) || 0,
        advance_amount: parseFloat(document.getElementById("advanceAmount").value) || 0,
        created_by: localStorage.getItem("uid"),
        status: "Pending",
        created_at: document.getElementById("orderDate").value
      };

      try {
        const { data, error } = await supabaseClient
          .from("orders")
          .insert([order])
          .select("order_code, order_id, pending_amount");

        if (error) {
          alert("Error submitting order: " + error.message);
        } else {
          alert(
            "âœ… Order created successfully!\n" +
            "Code: " + data[0].order_code + "\n" +
            "ID: " + data[0].order_id + "\n" +
            "Pending: " + data[0].pending_amount
          );
          document.getElementById("orderForm").reset();
          document.getElementById("orderDate").value = new Date().toISOString().split("T")[0];
          document.getElementById("pendingAmount").value = "";
        }
      } catch (err) {
        alert("Unexpected error: " + err.message);
      }
    });
  </script>
</body>
</html>
