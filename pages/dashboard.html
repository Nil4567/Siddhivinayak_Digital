<script src="../script.js"></script>
<script>
    // 1. Authentication Check (from script.js)
    checkAuth();
    
    // --- Dashboard Helper Functions ---
    
    // Loads all jobs stored in the browser's local storage
    function loadLocalJobs() {
      // Assumes job data is stored under the key 'sv_jobs'
      const jobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
      return jobs;
    }

    // Helper function to return the correct CSS class for status coloring
    function getStatusClass(status) {
      switch (status) {
        case 'Completed': return 'status-completed';
        case 'Working': return 'status-working';
        case 'Hold': return 'status-hold';
        default: return 'status-pending';
      }
    }

    // --- Main Dashboard Rendering Logic ---
    function renderDashboard() {
        const allJobs = loadLocalJobs();
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        
        let todayJobCount = 0;
        let pendingJobCount = 0;
        let completedJobCount = 0;
        
        // Count jobs and determine status
        allJobs.forEach(job => {
            // 1. Calculate Today's Jobs (based on job date/createdAt)
            const jobDate = job.createdAt ? job.createdAt.slice(0, 10) : '';
            if (jobDate === today) {
                todayJobCount++;
            }
            
            // 2. Calculate Status Counts
            if (job.status === 'Pending' || job.status === 'Working' || job.status === 'Hold') {
                pendingJobCount++;
            } else if (job.status === 'Completed') {
                completedJobCount++;
            }
        });
        
        // Sort jobs by creation time (newest first)
        const sortedJobs = [...allJobs].sort((a, b) => {
            // Use createdAt or a similar timestamp for accurate sorting
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        const latestJobs = sortedJobs.slice(0, 7); // Show the top 7 most recent jobs

        // --- Display Counts ---
        document.getElementById('todayJobs').textContent = todayJobCount;
        document.getElementById('pendingJobs').textContent = pendingJobCount;
        document.getElementById('completedJobs').textContent = completedJobCount;

        // --- Display Recent Jobs Table ---
        const tbody = document.querySelector('#recentTable tbody');
        tbody.innerHTML = ''; 

        if (latestJobs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="muted">No jobs yet</td></tr>';
        } else {
            latestJobs.forEach(job => {
                const row = document.createElement('tr');
                
                // Format job time 
                const jobTime = job.createdAt ? new Date(job.createdAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : 'N/A';

                row.innerHTML = `
                    <td>${job.id}</td>
                    <td>${job.customer || 'N/A'}</td>
                    <td>${job.department || 'N/A'}</td>
                    <td class="${getStatusClass(job.status)}">${job.status}</td>
                    <td>${jobTime}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    // Initialize the dashboard
    renderDashboard();

</script>
