<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
      <span id="sv_user_name"></span>
      <span id="liveTime"></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link active">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a> <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Dashboard</div>
          <div class="page-sub">Overview of jobs and job manager load</div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card">
          <h3>Today's Jobs</h3>
          <div class="big" id="todayJobs">0</div> 
        </div>
        <div class="card">
          <h3>Pending</h3>
          <div class="big" id="pendingJobs">0</div>
        </div>
        <div class="card">
          <h3>Completed</h3>
          <div class="big" id="completedJobs">0</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:16px">
        <h3>Recent Jobs</h3>
        <table class="table" id="recentTable">
          <thead>
            <tr><th>Order ID</th><th>Customer</th><th>Manager</th><th>Amount (Rs)</th><th>Status</th><th>Time</th></tr>
          </thead>
          <tbody><tr><td colspan="6" class="muted">Loading jobs...</td></tr></tbody>
        </table>
      </div>

      <div class="actions">
        <a class="btn" href="job-entry.html">New Job</a>
        <a class="btn secondary" href="job-queue.html">Open Queue</a>
      </div>

    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // 1. Authentication Check (from script.js)
    checkAuth();
    
    // --- Dashboard Helper Functions (CRITICAL) ---
    
    // Loads all jobs stored in the browser's local storage
    function loadLocalJobs() {
      const jobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
      return jobs;
    }

    // Helper function to return the correct CSS class for status coloring
    function getStatusClass(status) {
      switch (status) {
        case 'Completed': return 'status-completed';
        case 'Working': return 'status-working';
        case 'Hold': return 'status-hold';
        default: return 'status-pending';
      }
    }

    // --- Main Dashboard Rendering Logic ---
    function renderDashboard() {
        const allJobs = loadLocalJobs();
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        
        let todayJobCount = 0;
        let pendingJobCount = 0;
        let completedJobCount = 0;
        
        // Count jobs and determine status
        allJobs.forEach(job => {
            const jobDate = job.createdAt ? job.createdAt.slice(0, 10) : '';
            if (jobDate === today) {
                todayJobCount++;
            }
            
            if (job.status === 'Pending' || job.status === 'Working' || job.status === 'Hold') {
                pendingJobCount++;
            } else if (job.status === 'Completed') {
                completedJobCount++;
            }
        });
        
        // Sort jobs by creation time (newest first)
        const sortedJobs = [...allJobs].sort((a, b) => {
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        const latestJobs = sortedJobs.slice(0, 7);

        // --- Display Counts ---
        let el = document.getElementById('todayJobs');
        if (el) el.textContent = todayJobCount;

        el = document.getElementById('pendingJobs');
        if (el) el.textContent = pendingJobCount;

        el = document.getElementById('completedJobs');
        if (el) el.textContent = completedJobCount;

        // --- Display Recent Jobs Table (Updated columns) ---
        const tbody = document.querySelector('#recentTable tbody');
        
        if (tbody) { 
            tbody.innerHTML = ''; 

            if (latestJobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="muted">No jobs yet</td></tr>';
            } else {
                latestJobs.forEach(job => {
                    const row = document.createElement('tr');
                    const jobTime = job.createdAt ? new Date(job.createdAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                    
                    const isExpress = (job.urgency === 'Urgent' || job.urgency === 'Very Urgent') ? 'status-express' : '';

                    row.className = isExpress;

                    row.innerHTML = `
                        <td>${job.id}</td>
                        <td>${job.customer || 'N/A'}</td>
                        <td>${job.assignedPerson || 'N/A'}</td>
                        <td>₹ ${job.amount || '0'}</td>
                        <td class="${getStatusClass(job.status)}">${job.status}</td>
                        <td>${jobTime}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
    }

    // Initialize the dashboard
    renderDashboard();

</script>
</html>
