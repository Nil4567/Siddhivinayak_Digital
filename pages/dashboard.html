<script src="../script.js"></script>
<script>
    // 1. Authentication Check (from script.js)
    checkAuth();
    
    // --- Dashboard Helper Functions (REQUIRED) ---
    
    function loadLocalJobs() {
      // Assumes job data is stored under the key 'sv_jobs'
      const jobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
      return jobs;
    }

    function getStatusClass(status) {
      switch (status) {
        case 'Completed': return 'status-completed';
        case 'Working': return 'status-working';
        case 'Hold': return 'status-hold';
        default: return 'status-pending';
      }
    }

    // --- Main Dashboard Rendering Logic ---
    function renderDashboard() {
        const allJobs = loadLocalJobs();
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        
        let todayJobCount = 0;
        let pendingJobCount = 0;
        let completedJobCount = 0;
        
        // Count jobs and determine status
        allJobs.forEach(job => {
            const jobDate = job.createdAt ? job.createdAt.slice(0, 10) : '';
            if (jobDate === today) {
                todayJobCount++;
            }
            
            if (job.status === 'Pending' || job.status === 'Working' || job.status === 'Hold') {
                pendingJobCount++;
            } else if (job.status === 'Completed') {
                completedJobCount++;
            }
        });
        
        // Sort jobs by creation time (newest first)
        const sortedJobs = [...allJobs].sort((a, b) => {
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        const latestJobs = sortedJobs.slice(0, 7);

        // --- Display Counts (CRASH PREVENTION ADDED) ---
        // If the element is not found (null), the script skips it instead of crashing.
        let el = document.getElementById('todayJobs');
        if (el) el.textContent = todayJobCount;

        el = document.getElementById('pendingJobs');
        if (el) el.textContent = pendingJobCount;

        el = document.getElementById('completedJobs');
        if (el) el.textContent = completedJobCount;

        // --- Display Recent Jobs Table ---
        const tbody = document.querySelector('#recentTable tbody');
        
        // Only try to update the table if the table body exists
        if (tbody) { 
            tbody.innerHTML = ''; 

            if (latestJobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="muted">No jobs yet</td></tr>';
            } else {
                latestJobs.forEach(job => {
                    const row = document.createElement('tr');
                    const jobTime = job.createdAt ? new Date(job.createdAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' }) : 'N/A';

                    row.innerHTML = `
                        <td>${job.id}</td>
                        <td>${job.customer || 'N/A'}</td>
                        <td>${job.department || 'N/A'}</td>
                        <td class="${getStatusClass(job.status)}">${job.status}</td>
                        <td>${jobTime}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
    }

    // Initialize the dashboard
    renderDashboard();

</script>
