<script src="../script.js"></script>
<script>
    const saveAdminCredentials = window.saveAdminCredentials;
    const getAdminCredentials = window.getAdminCredentials;
    
    // --- Form Locking Logic ---
    function lockForm(credsExist) {
        document.getElementById('scriptUrl').disabled = true;
        document.getElementById('securityToken').disabled = true;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = ''; 
        
        if (credsExist) {
            // Only Admin users can unlock/edit the credentials
            if (localStorage.getItem('sv_user_role') === 'admin') {
                const editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'btn secondary';
                editBtn.textContent = 'Edit Credentials';
                editBtn.onclick = unlockForm;
                controls.appendChild(editBtn);
            }
        } else {
            const saveBtn = document.createElement('button');
            saveBtn.type = 'submit';
            saveBtn.className = 'btn';
            saveBtn.textContent = 'Save Credentials';
            controls.appendChild(saveBtn);
        }
    }

    function unlockForm() {
        document.getElementById('scriptUrl').disabled = false;
        document.getElementById('securityToken').disabled = false;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = '';
        
        const saveBtn = document.createElement('button');
        saveBtn.type = 'submit';
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Save Changes';
        controls.appendChild(saveBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = function() {
             loadCredentials(); 
        };
        controls.appendChild(cancelBtn);
    }
    
    // --- Load and Display Data ---
    function loadCredentials() {
        const creds = getAdminCredentials();
        const credsExist = !!creds.url && !!creds.token;
        
        document.getElementById('currentScriptUrl').textContent = creds.url || 'Not Set';
        document.getElementById('currentToken').textContent = creds.token ? '*** SECRET ***' : 'Not Set';
        
        document.getElementById('scriptUrl').value = creds.url || '';
        document.getElementById('securityToken').value = creds.token || '';

        lockForm(credsExist);
    }

    // --- Save Handler ---
    document.getElementById('credentialForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const url = document.getElementById('scriptUrl').value.trim();
        const token = document.getElementById('securityToken').value.trim();
        
        if (!url || !token) {
            alert("Both the Script URL and Security Token are required.");
            return;
        }
        if (!url.endsWith('/exec')) {
            alert("The Google Apps Script URL must be a valid deployment URL ending in '/exec'.");
            return;
        }

        saveAdminCredentials(url, token);
        loadCredentials(); 
        alert("Google Apps Script Credentials saved and locked successfully! âœ…");
    });
    
    // --- Initialization ---
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth(); // This is in script.js and handles login/access redirect
        
        // CRITICAL: Call loadCredentials to populate the form and set the lock state
        loadCredentials();
    });
    
    window.unlockForm = unlockForm;
    window.lockForm = lockForm;
    window.loadCredentials = loadCredentials;
</script>
