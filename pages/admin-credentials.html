<script src="../script.js"></script>
  <script>
    const saveAdminCredentials = window.saveAdminCredentials;
    const getAdminCredentials = window.getAdminCredentials;
    
    // --- Form Locking Logic ---
    function lockForm(credsExist) {
        document.getElementById('scriptUrl').disabled = true;
        document.getElementById('securityToken').disabled = true;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = ''; // Clear existing buttons
        
        // When credentials exist, display the 'Edit' button. 
        if (credsExist) {
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn secondary';
            editBtn.textContent = 'Edit Credentials';
            editBtn.onclick = unlockForm;
            controls.appendChild(editBtn);
        } else {
            // If credentials DON'T exist, force the user to save initially.
            const saveBtn = document.createElement('button');
            saveBtn.type = 'submit';
            saveBtn.className = 'btn';
            saveBtn.textContent = 'Save Credentials';
            controls.appendChild(saveBtn);
        }
    }

    function unlockForm() {
        document.getElementById('scriptUrl').disabled = false;
        document.getElementById('securityToken').disabled = false;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = '';
        
        // Show Save and Cancel buttons when editing
        const saveBtn = document.createElement('button');
        saveBtn.type = 'submit';
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Save Changes';
        controls.appendChild(saveBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        // When canceling, reload the saved data and re-lock
        cancelBtn.onclick = function() {
             loadCredentials(); 
        };
        controls.appendChild(cancelBtn);
    }
    
    // --- Load and Display Data ---
    function loadCredentials() {
        const creds = getAdminCredentials();
        // Check if both properties are non-empty to determine if credentials exist
        const credsExist = !!creds.url && !!creds.token;
        
        document.getElementById('currentScriptUrl').textContent = creds.url || 'Not Set';
        // Hide the token value for security
        document.getElementById('currentToken').textContent = creds.token ? '*** SECRET ***' : 'Not Set';
        
        // Populate form fields
        document.getElementById('scriptUrl').value = creds.url || '';
        document.getElementById('securityToken').value = creds.token || '';

        // Apply lock status based on whether credentials were found
        lockForm(credsExist);
    }

    // --- Save Handler ---
    document.getElementById('credentialForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const url = document.getElementById('scriptUrl').value.trim();
        const token = document.getElementById('securityToken').value.trim();
        
        if (!url || !token) {
            alert("Both the Script URL and Security Token are required.");
            return;
        }
        if (!url.endsWith('/exec')) {
            alert("The Google Apps Script URL must be a valid deployment URL ending in '/exec'.");
            return;
        }

        saveAdminCredentials(url, token);
        loadCredentials(); // Reloads data, updates display, and re-locks the form
        alert("Google Apps Script Credentials saved and locked successfully! âœ…");
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        // This is the CRITICAL line that runs the authentication check and the lock mechanism
        checkAuth(); 
        loadCredentials();
    });

    // Make functions globally accessible for inline HTML calls (if needed, though we use buttons)
    window.unlockForm = unlockForm; 
    window.lockForm = lockForm;
  </script>
