<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Admin Credentials â€” Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        .credentials-card {
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
        }
        .field label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .data-display {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            background-color: var(--highlight);
        }
        .data-display p {
            margin: 5px 0;
            word-break: break-all;
        }
        .data-display strong {
            color: var(--primary);
        }
        #formControls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .btn-save {
            background-color: var(--success);
            color: white;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link">User Management</a>
            <a href="admin-credentials.html" class="nav-link active">Admin Credentials</a>
        </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">Google Apps Script Credentials</div>
                    <div class="page-sub">Only the Admin can configure the external data storage script URL and security token.</div>
                </div>
            </div>

            <div class="card credentials-card">
                <div class="alert warning">
                    <strong>CRITICAL SECURITY NOTE:</strong> These fields control all data saving (Jobs, Expenses). Ensure the Script URL is correctly deployed and the Token is strong.
                </div>

                <h3>Current Saved Credentials</h3>
                <div class="data-display">
                    <p>Deployed Script URL: <strong id="currentScriptUrl">Not Set</strong></p>
                    <p>Security Token: <strong id="currentToken">Not Set</strong></p>
                </div>
                
                <h3 style="margin-top: 20px;">Set New Credentials</h3>
                
                <form id="credentialForm"> 
                    <div class="field">
                        <label for="scriptUrl">Deployed Google Apps Script URL (Ending in '/exec')</label>
                        <input type="url" id="scriptUrl" name="scriptUrl" required placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    
                    <div class="field">
                        <label for="securityToken">Security Token (Custom Strong Key - e.g., SD-SECRET-001)</label>
                        <input type="text" id="securityToken" name="securityToken" required placeholder="Generate a unique, long token">
                    </div>
                    
                    <div id="formControls">
                        <button type="submit" id="saveButton" class="btn btn-save">Save Credentials</button>
                        <button type="button" id="editButton" class="btn secondary">Edit Current</button>
                        <button type="button" id="cancelButton" class="btn secondary" style="display: none;">Cancel</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Access global functions from script.js
        const getAdminCredentials = window.getAdminCredentials;
        const saveAdminCredentials = window.saveAdminCredentials;
        
        const form = document.getElementById('credentialForm');
        const scriptUrlInput = document.getElementById('scriptUrl');
        const tokenInput = document.getElementById('securityToken');
        const saveButton = document.getElementById('saveButton');
        const editButton = document.getElementById('editButton');
        const cancelButton = document.getElementById('cancelButton');
        
        let initialCredentials = {};

        // --- UI State Management ---
        function lockForm(creds) {
            scriptUrlInput.value = creds.url;
            tokenInput.value = creds.token;

            scriptUrlInput.readOnly = true;
            tokenInput.readOnly = true;
            saveButton.style.display = 'none';
            cancelButton.style.display = 'none';
            editButton.style.display = 'inline-block';
        }

        function unlockForm() {
            scriptUrlInput.readOnly = false;
            tokenInput.readOnly = false;
            saveButton.style.display = 'inline-block';
            cancelButton.style.display = 'inline-block';
            editButton.style.display = 'none';
        }

        function displayCredentials() {
            initialCredentials = getAdminCredentials();
            
            document.getElementById('currentScriptUrl').textContent = initialCredentials.url || 'Not Set';
            document.getElementById('currentToken').textContent = initialCredentials.token || 'Not Set';

            if (initialCredentials.url) {
                lockForm(initialCredentials);
            } else {
                // If credentials are empty, force form open
                unlockForm();
            }
        }

        // --- Event Handlers ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newUrl = scriptUrlInput.value.trim();
            const newToken = tokenInput.value.trim();

            if (!newUrl.endsWith('/exec')) {
                alert("The Script URL must end with '/exec' (deployed Web App URL).");
                return;
            }

            if (newUrl === initialCredentials.url && newToken === initialCredentials.token) {
                 alert("No changes detected. Credentials were not saved.");
                 lockForm(initialCredentials);
                 return;
            }

            if (confirm("Are you sure you want to save these new credentials? This will affect all data saving.")) {
                const savedCreds = saveAdminCredentials(newUrl, newToken);
                alert("New credentials saved successfully!");
                displayCredentials(); // Re-render and lock the form
            }
        });

        editButton.addEventListener('click', unlockForm);
        
        cancelButton.addEventListener('click', function() {
            // Revert inputs to the saved values and lock
            displayCredentials();
        });


        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Check Auth & Load Header/Sidebar (from script.js)
            checkAuth(); 

            // 2. Only Admin should be here for security reasons (redundant check, but safe)
            if (localStorage.getItem('sv_user_role') !== 'admin') {
                alert("Access Denied: Only Administrator can access this page.");
                window.location.href = '../pages/dashboard.html';
                return;
            }
            
            // 3. Load and display credentials
            displayCredentials();
        });
    </script>
</body>
</html>
