<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Credentials — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    .card-large {
        max-width: 800px;
        margin: 20px auto;
        padding: 30px;
    }
    .warning {
        padding: 15px;
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
    }
    .field-group {
        margin-bottom: 15px;
    }
    .saved-url {
        font-family: monospace;
        background-color: #f4f4f4;
        padding: 8px;
        display: block;
        border-radius: 4px;
        word-break: break-all;
    }
    /* Style for locked state */
    #scriptUrl[disabled], #securityToken[disabled] {
        background-color: #f8f8f8;
        cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="expenses.html" class="nav-link">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">User Settings</a>
      <a href="admin-credentials.html" class="nav-link active">Admin Credentials</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Google Apps Script Credentials</div>
          <div class="page-sub">Only the Admin can configure the external data storage script URL and security token.</div>
        </div>
      </div>
      
      <div class="card card-large">
        <div class="warning">
            ⚠️ **CRITICAL SECURITY NOTE:** These fields control all data saving (Jobs, Expenses). Ensure the Google Script URL is correctly deployed and the Token is strong.
        </div>

        <h3>Current Saved Credentials</h3>
        <p>Deployed Script URL: <strong id="currentScriptUrl">Not Set</strong></p>
        <p>Security Token: <strong id="currentToken">Not Set</strong></p>
        <hr>

        <h3>Set New Credentials</h3>
        <form id="credentialForm">
            <div class="field-group">
                <label for="scriptUrl">Deployed Google Apps Script URL (Ending in `/exec`)</label>
                <input type="url" id="scriptUrl" required placeholder="https://script.google.com/macros/s/.../exec">
            </div>
            <div class="field-group">
                <label for="securityToken">Security Token (Custom Strong Key - e.g., SD-SECRET-001)</label>
                <input type="text" id="securityToken" required placeholder="Generate a unique, long token">
            </div>
            <div id="formControls">
                </div>
        </form>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    const saveAdminCredentials = window.saveAdminCredentials;
    const getAdminCredentials = window.getAdminCredentials;
    
    // --- Form Locking Logic ---
    function lockForm(credsExist) {
        document.getElementById('scriptUrl').disabled = true;
        document.getElementById('securityToken').disabled = true;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = ''; // Clear existing buttons
        
        if (credsExist) {
            // Credentials exist: show the EDIT button
            const editBtn = document.createElement('button');
            editBtn.type = 'button';
            editBtn.className = 'btn secondary';
            editBtn.textContent = 'Edit Credentials';
            editBtn.onclick = unlockForm;
            controls.appendChild(editBtn);
        } else {
            // Credentials DO NOT exist: force the user to save
            const saveBtn = document.createElement('button');
            saveBtn.type = 'submit';
            saveBtn.className = 'btn';
            saveBtn.textContent = 'Save Credentials';
            controls.appendChild(saveBtn);
        }
    }

    function unlockForm() {
        document.getElementById('scriptUrl').disabled = false;
        document.getElementById('securityToken').disabled = false;
        
        const controls = document.getElementById('formControls');
        controls.innerHTML = '';
        
        // Show Save and Cancel buttons
        const saveBtn = document.createElement('button');
        saveBtn.type = 'submit';
        saveBtn.className = 'btn';
        saveBtn.textContent = 'Save Changes';
        controls.appendChild(saveBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn secondary';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = function() {
             loadCredentials(); // Reloads data and re-locks
        };
        controls.appendChild(cancelBtn);
    }
    
    // --- Load and Display Data ---
    function loadCredentials() {
        const creds = getAdminCredentials();
        const credsExist = !!creds.url && !!creds.token;
        
        document.getElementById('currentScriptUrl').textContent = creds.url || 'Not Set';
        document.getElementById('currentToken').textContent = creds.token ? '*** SECRET ***' : 'Not Set';
        
        // Populate form fields
        document.getElementById('scriptUrl').value = creds.url || '';
        document.getElementById('securityToken').value = creds.token || '';

        lockForm(credsExist);
    }

    // --- Save Handler ---
    document.getElementById('credentialForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const url = document.getElementById('scriptUrl').value.trim();
        const token = document.getElementById('securityToken').value.trim();
        
        if (!url || !token) {
            alert("Both the Script URL and Security Token are required.");
            return;
        }
        if (!url.endsWith('/exec')) {
            alert("The Google Apps Script URL must be a valid deployment URL ending in '/exec'.");
            return;
        }

        saveAdminCredentials(url, token);
        loadCredentials(); // Reloads data, updates display, and re-locks the form
        alert("Google Apps Script Credentials saved and locked successfully! ✅");
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth(); 
        loadCredentials();
    });
  </script>
</body>
</html>
