<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Daily Expenses — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    /* Styling for Topbar User Display */
    .user-display {
        background: #e9f2ff; 
        color: #0b2540;
        padding: 5px 10px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        margin-right: 15px;
        border: 1px solid rgba(15,111,255,0.1);
    }
    .user-display span {
        font-weight: 800;
        color: var(--primary);
    }
    .expense-list {
        max-height: 400px;
        overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="expenses.html" class="nav-link active">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Daily Expenses</div>
          <div class="page-sub">Record all daily expenditures.</div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card">
            <h3>Record New Expense</h3>
            <form id="newExpenseForm">
                <div class="field">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" required>
                </div>
                <div class="field">
                    <label for="description">Expense Description *</label>
                    <input type="text" id="description" placeholder="e.g., Tea/Snacks, Printing Paper" required>
                </div>
                <div class="field">
                    <label for="amount">Amount (₹) *</label>
                    <input type="number" id="amount" required min="1" step="1">
                </div>
                <p id="expenseMsg" style="color: green; font-weight: 700; margin-top: 15px; display: none;"></p>
                <button type="submit" class="btn" style="width: 100%; margin-top: 10px;">Save Expense</button>
            </form>
        </div>

        <div class="card" style="grid-column: span 2;">
            <h3>Today's Expenses</h3>
            <div class="expense-list">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Description</th>
                            <th>Amount (₹)</th>
                            <th>Recorded By</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                        <tr><td colspan="4" style="text-align: center;">No expenses recorded today.</td></tr>
                    </tbody>
                </table>
            </div>
            <h4 style="margin-top: 20px;">Total Expenses Today: <span id="totalTodayExpense">₹ 0</span></h4>
        </div>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // Constants and functions expected from script.js
    const ACCESS_PERMISSIONS = window.ACCESS_PERMISSIONS || {}; 
    const saveExpenseToGitHub = window.saveExpenseToGitHub;
    const EXPENSE_STORAGE_KEY = 'sv_expenses'; // Standard key for expense storage
    const USER_ROLE = localStorage.getItem("sv_user_role");
    
    // --- Expense Specific Functions ---
    function renderExpenses() {
        const today = document.getElementById('expenseDate').value;
        if (!today) return;

        const allExpenses = JSON.parse(localStorage.getItem(EXPENSE_STORAGE_KEY) || '[]');
        const todayExpenses = allExpenses.filter(e => e.date === today);
        
        const tableBody = document.getElementById('expenseTableBody');
        const totalEl = document.getElementById('totalTodayExpense');
        tableBody.innerHTML = '';
        
        let totalAmount = 0;

        if (todayExpenses.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No expenses recorded for this date.</td></tr>';
        } else {
            todayExpenses.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            todayExpenses.forEach(expense => {
                totalAmount += parseFloat(expense.amount);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${new Date(expense.createdAt).toLocaleTimeString()}</td>
                    <td>${expense.description}</td>
                    <td>₹ ${expense.amount}</td>
                    <td>${expense.enteredBy || 'N/A'}</td>
                `;
            });
        }
        
        totalEl.textContent = `₹ ${totalAmount.toFixed(0)}`;
    }

    // --- Form Submission Logic ---
    document.getElementById('newExpenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const amount = parseFloat(form.amount.value) || 0;
        
        const newExpense = {
            id: 'E-' + Date.now().toString().slice(-6),
            date: form.expenseDate.value,
            description: form.description.value.trim(),
            amount: amount.toFixed(0),
            createdAt: new Date().toISOString(),
            enteredBy: localStorage.getItem('username') || 'Unknown'
        };

        // 1. Save to Local Storage
        const allExpenses = JSON.parse(localStorage.getItem(EXPENSE_STORAGE_KEY) || '[]');
        allExpenses.push(newExpense);
        localStorage.setItem(EXPENSE_STORAGE_KEY, JSON.stringify(allExpenses));

        // 2. Dispatch to GitHub (if function exists)
        const msgEl = document.getElementById('expenseMsg');
        msgEl.style.color = 'orange';
        msgEl.textContent = `Expense saved locally. Dispatching...`;
        msgEl.style.display = 'block';

        let success = true;
        try {
            if (typeof saveExpenseToGitHub === 'function') {
                success = await saveExpenseToGitHub(newExpense); 
            } else {
                console.warn("saveExpenseToGitHub function not found. Expense saved locally only.");
            }
        } catch (e) {
            console.error("Error during GitHub dispatch:", e);
            success = false;
        }

        if (success) {
            msgEl.style.color = 'green';
            msgEl.textContent = `✅ Expense recorded successfully!`;
        } else {
            msgEl.style.color = 'red';
            msgEl.textContent = `❌ Expense saved locally, but failed to reach central record.`;
        }
        
        // Reset form for next entry, keep date
        form.description.value = '';
        form.amount.value = '';
        
        renderExpenses(); // Update the list
    });

    // --- Initialization and Role-Based Access Filter (START) ---
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Run the primary authentication check (includes initHeader and checkAccess)
        if (typeof checkAuth === 'function') {
            checkAuth(); 
        } else {
            console.error("checkAuth() function not found. Ensure script.js is loaded.");
            return;
        }
        
        // 2. Set default date to today and attach listener
        const dateInput = document.getElementById('expenseDate');
        dateInput.valueAsDate = new Date();
        dateInput.addEventListener('change', renderExpenses);
        
        // 3. Render initial expenses for today
        renderExpenses();
        
        // 4. Access Control Navigation Filter
        const allowedPages = ACCESS_PERMISSIONS[USER_ROLE] || [];
        
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            const href = link.getAttribute('href');
            const pageName = href ? href.split('/').pop() : '';
            
            // Hide the link if the current role doesn't have permission
            if (pageName && !allowedPages.includes(pageName)) {
                link.style.display = 'none';
            }
        });
    });
    // --- Initialization and Role-Based Access Filter (END) ---
  </script>
</body>
</html>
