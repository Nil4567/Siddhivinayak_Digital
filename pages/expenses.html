<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Daily Expenses — Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        .expense-form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        .expense-form .field {
            margin-bottom: 15px;
        }
        .expense-form textarea {
            min-height: 80px;
            resize: vertical;
        }
        .btn-save {
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link active">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link">User Management</a>
            <a href="admin-credentials.html" class="nav-link">Admin Credentials</a>
        </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">Daily Expenses Entry</div>
                    <div class="page-sub">Record daily operational expenditures.</div>
                </div>
            </div>

            <div class="card expense-form">
                <h3>Record Expense</h3>
                <form id="expenseEntryForm">
                    
                    <div class="field">
                        <label for="expenseDate">Date *</label>
                        <input type="date" id="expenseDate" required>
                    </div>

                    <div class="field">
                        <label for="expenseCategory">Category *</label>
                        <select id="expenseCategory" required>
                            <option value="">-- Select Category --</option>
                            <option value="Raw Material">Raw Material (Paper, Ink, etc.)</option>
                            <option value="Utilities">Utilities (Electricity, Water, Internet)</option>
                            <option value="Staff Wages">Staff Wages/Salaries</option>
                            <option value="Rent">Rent</option>
                            <option value="Maintenance">Maintenance/Repairs</option>
                            <option value="Other">Other Operational Expense</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="expenseAmount">Amount (₹) *</label>
                        <input type="number" id="expenseAmount" required min="0.01" step="0.01">
                    </div>
                    
                    <div class="field">
                        <label for="expenseDescription">Description / Note</label>
                        <textarea id="expenseDescription" placeholder="e.g., Purchased 5 reams of A4 80gsm paper"></textarea>
                    </div>

                    <div class="field">
                        <label for="recordedBy">Recorded By *</label>
                        <input type="text" id="recordedBy" required readonly>
                    </div>

                    <button type="submit" class="btn btn-save">Save Expense</button>
                </form>
            </div>

        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Access global functions from script.js
        const saveExpenseToScript = window.saveExpenseToScript;
        
        // --- Form Submission Handler ---
        document.getElementById('expenseEntryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const expenseDate = form.expenseDate.value;
            const expenseCategory = form.expenseCategory.value;
            const expenseAmount = parseFloat(form.expenseAmount.value);
            const expenseDescription = form.expenseDescription.value.trim();
            const recordedBy = form.recordedBy.value;

            // Simple validation check
            if (expenseAmount <= 0) {
                alert("Expense amount must be greater than zero.");
                return;
            }
            
            const newExpense = {
                date: expenseDate,
                category: expenseCategory,
                amount: expenseAmount,
                description: expenseDescription,
                recordedBy: recordedBy
            };
            
            // Call the external save function
            const success = await saveExpenseToScript(newExpense);

            if (success) {
                alert(`Expense of ₹${expenseAmount.toFixed(2)} (${expenseCategory}) saved successfully!`);
                form.reset();
                // Set date and recordedBy after reset
                document.getElementById('expenseDate').valueAsDate = new Date();
                document.getElementById('recordedBy').value = localStorage.getItem('username') || 'Unknown';
            } else {
                // saveExpenseToScript alerts the user on failure
                console.error("Expense saving failed.");
            }
        });

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            // 1. Check Auth & Load Header/Sidebar (from script.js)
            checkAuth(); 
            
            // 2. Set the default date to today
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            // 3. Auto-fill the 'Recorded By' field with the logged-in user
            const loggedInUser = localStorage.getItem('username');
            if (loggedInUser) {
                document.getElementById('recordedBy').value = loggedInUser;
            } else {
                 document.getElementById('recordedBy').value = 'Unknown User';
            }
        });
    </script>
</body>
</html>
