<script>
    // Run this function after checkAuth() has ensured the user is logged in
    document.addEventListener("DOMContentLoaded", function() {
        // --- Access Control Navigation Filter ---
        const userRole = localStorage.getItem("sv_user_role");
        const allowedPages = ACCESS_PERMISSIONS[userRole] || [];
        
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                const pageName = href.split('/').pop();
                
                // Hide the link if the current role doesn't have permission
                if (!allowedPages.includes(pageName)) {
                    link.style.display = 'none';
                }
            }
        });
    });
</script>

<!doctype html>
<html>
<head>
  <meta charset="utf-8"><title>Departments</title>
  <link rel="stylesheet" href="../styles/internal.css">
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls"><div id="sv_user_name"></div><button class="btn" onclick="logout()">Logout</button></div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Departments</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Departments</div>
          <div class="page-sub">Workload per department</div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card"><h3>Data Entry</h3><p>Pending: <span id="d_dataentry">0</span></p></div>
        <div class="card"><h3>Checking</h3><p>Pending: <span id="d_check">0</span></p></div>
        <div class="card"><h3>Printing</h3><p>Pending: <span id="d_print">0</span></p></div>
      </div>

      <div class="card">
        <h3>Department details</h3>
        <p>Use Job Queue to move jobs between departments and update status.</p>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    checkAuth();
    (function updateCounts(){
      const jobs = JSON.parse(localStorage.getItem('sv_jobs')||'[]');
      const counts = {dataentry:0,check:0,print:0};
      jobs.forEach(j=>{
        const d = (j.department||'').toLowerCase();
        if(d.includes('data')) counts.dataentry++;
        else if(d.includes('check')) counts.check++;
        else if(d.includes('print')) counts.print++;
      });
      document.getElementById('d_dataentry').textContent = counts.dataentry;
      document.getElementById('d_check').textContent = counts.check;
      document.getElementById('d_print').textContent = counts.print;
    })();
  </script>
</body>
</html>
