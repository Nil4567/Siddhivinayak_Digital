<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Job Queue â€” Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    /* Custom styles for TAT indicators */
    .tat-ontime {
        font-weight: 700;
        color: #1b5e20; /* Dark Green */
    }
    .tat-overdue {
        font-weight: 700;
        color: #d84315; /* Dark Red-Orange */
        background: #ffebee; /* Lightest Red */
        padding: 2px 4px;
        border-radius: 4px;
    }
    .muted {
        color: var(--muted);
    }
    
    /* Ensure table headers for new fields are compact */
    #jobQueueTable th {
        font-size: 11px;
        padding: 8px 6px;
    }
    #jobQueueTable td {
        font-size: 13px;
        padding: 6px;
        text-align: center; /* Center align TAT numbers */
    }
    #jobQueueTable td:nth-child(2) { text-align: left; } /* Customer name left align */
    #jobQueueTable td:nth-child(7), #jobQueueTable td:nth-child(8) { text-align: right; } /* Amount fields right align */
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
      <span id="sv_user_name"></span>
      <span id="liveTime"></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link active">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Job Queue</div>
          <div class="page-sub">Pending jobs with Turnaround Time (TAT) Tracking</div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card" style="background:#eef3ff;">
          <h3>Total Active Jobs</h3>
          <div class="big" id="totalActiveJobs">0</div>
        </div>
        <div class="card" style="background:#fff3e0;">
          <h3>Total Pending TAT (Days)</h3>
          <div class="big" id="totalPendingTAT">0</div>
        </div>
        <div class="card" style="background:#ffebee;">
          <h3>Overdue Jobs</h3>
          <div class="big" id="overdueJobs">0</div>
        </div>
      </div>

      <div class="card">
        <h3>Active Jobs Queue</h3>
        <table class="table" id="jobQueueTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Manager</th>
              <th>Status</th>
              <th>Total TAT (Days)</th>
              <th>Pending TAT (Days)</th>
              <th>Amount (Rs.)</th>
              <th>Pending Amount (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="8" class="muted">Loading job queue...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="card" style="margin-top: 15px;">
        <h3>Manager Pending TAT Summary</h3>
        <table class="table" id="managerSummaryTable">
            <thead>
                <tr>
                    <th>Manager Name</th>
                    <th>Pending Jobs</th>
                    <th>Total Pending TAT (Days)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3" class="muted">Calculating summary...</td></tr>
            </tbody>
        </table>
      </div>
      
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // 1. Authentication Check
    checkAuth();
    
    // --- CONSTANTS ---
    const MS_PER_DAY = 1000 * 60 * 60 * 24;
    // TAT is 0 days (Same Day)
    const DEFAULT_TAT_DAYS = 0; 
    
    // --- Helper Functions ---
    
    // Utility to calculate the difference in full days between two dates (A - B)
    function dateDiffInDays(dateA, dateB) {
        if (!dateA || !dateB) return 0;
        
        const date1 = new Date(dateA);
        const date2 = new Date(dateB);
        
        // Reset time to midnight to ensure accurate day difference calculation
        date1.setUTCHours(0, 0, 0, 0);
        date2.setUTCHours(0, 0, 0, 0);
        
        const diffTime = date1.getTime() - date2.getTime();
        return Math.ceil(diffTime / MS_PER_DAY); 
    }
    
    function loadLocalJobs() {
      // Load jobs saved by job-entry.html
      return JSON.parse(localStorage.getItem('sv_jobs') || '[]');
    }
    
    function getStatusClass(status) {
      switch (status) {
        case 'Completed': return 'status-completed';
        case 'Working': return 'status-working';
        case 'Hold': return 'status-hold';
        default: return 'status-pending';
      }
    }
    
    // --- Main Rendering Logic ---
    function renderJobQueue() {
      const allJobs = loadLocalJobs();
      const tbody = document.querySelector('#jobQueueTable tbody');
      const summaryTbody = document.querySelector('#managerSummaryTable tbody');
      
      if (!tbody) return;
      tbody.innerHTML = '';
      
      const today = new Date().toISOString().slice(0, 10);
      const activeJobs = allJobs.filter(job => job.status !== 'Completed'); 

      let totalPendingTATDays = 0; // Tracks accumulated overdue days across all jobs
      let overdueCount = 0;
      const managerTATSummary = {}; 
      
      if (activeJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="muted">The Job Queue is empty! ðŸŽ‰</td></tr>';
      } else {
        
        // Sort by Order Date (Oldest/Overdue first)
        activeJobs.sort((a, b) => {
            return new Date(a.orderDate) - new Date(b.orderDate);
        });

        activeJobs.forEach(job => {
            // Target Date is implicitly Order Date as TAT is 0 days (Same Day)
            job.targetCompletionDate = job.orderDate; 
            
            let pendingTATDays = 0; // The number to display
            let tatClass = 'tat-ontime';
            let displayValue = 0; // Default to 0 days remaining

            if (job.status !== 'Hold') { 
                 // Calculate difference: Target Date (Order Date) minus Today's Date.
                 // If the result is negative, the job is overdue.
                 const diff = dateDiffInDays(job.targetCompletionDate, today); 

                 if (diff < 0) {
                     // Job is overdue. The number is the absolute days past target.
                     pendingTATDays = Math.abs(diff); 
                     tatClass = 'tat-overdue';
                     overdueCount++;
                     displayValue = pendingTATDays;
                 } else {
                     // Job is on time (or due today).
                     pendingTATDays = 0;
                     displayValue = pendingTATDays;
                 }
            } else {
                tatClass = 'muted';
                displayValue = 'N/A';
            }
            
            // Update global TAT counter: only count OVERDUE days
            if (job.status !== 'Hold' && tatClass === 'tat-overdue') {
                totalPendingTATDays += pendingTATDays;
            }

            // Update Manager TAT Summary (only count overdue days)
            const manager = job.assignedPerson;
            if (!managerTATSummary[manager]) {
                managerTATSummary[manager] = { pendingJobs: 0, totalPendingTAT: 0 };
            }
            managerTATSummary[manager].pendingJobs++;
            
            if (job.status !== 'Hold' && tatClass === 'tat-overdue') {
                 managerTATSummary[manager].totalPendingTAT += pendingTATDays;
            }
            
            const row = document.createElement('tr');
            
            // The table headers only show required data:
            row.innerHTML = `
              <td>#${job.id}</td>
              <td style="text-align: left;">${job.customer}</td>
              <td>${job.assignedPerson}</td>
              <td class="${getStatusClass(job.status)}">${job.status}</td>
              <td>${DEFAULT_TAT_DAYS}</td> <td><span class="${tatClass}">${displayValue}</span></td> <td>â‚¹ ${job.amount}</td>
              <td>â‚¹ ${job.pendingAmount}</td>
            `;
            tbody.appendChild(row);
        });
      }
      
      // Update Summary Cards
      document.getElementById('totalActiveJobs').textContent = activeJobs.length;
      document.getElementById('totalPendingTAT').textContent = totalPendingTATDays;
      document.getElementById('overdueJobs').textContent = overdueCount;
      
      // Update Manager Summary Table
      summaryTbody.innerHTML = '';
      const managerNames = Object.keys(managerTATSummary).sort();
      
      if (managerNames.length === 0) {
          summaryTbody.innerHTML = '<tr><td colspan="3" class="muted">No active managers found.</td></tr>';
      } else {
          managerNames.forEach(manager => {
              const summary = managerTATSummary[manager];
              const summaryRow = document.createElement('tr');
              // Display only the number for totalPendingTAT
              summaryRow.innerHTML = `
                  <td>${manager}</td>
                  <td>${summary.pendingJobs}</td>
                  <td>${summary.totalPendingTAT}</td> 
              `;
              summaryTbody.appendChild(summaryRow);
          });
      }
    }

    // Initialize the page
    document.addEventListener("DOMContentLoaded", renderJobQueue);

  </script>
</body>
</html>
