<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Job Queue â€” Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    /* Custom styles for TAT indicators */
    .tat-ontime {
        font-weight: 700;
        color: #1b5e20; /* Dark Green */
    }
    .tat-due-soon {
        font-weight: 700;
        color: #ffa000; /* Amber - Not really used here, but kept for context */
    }
    .tat-overdue {
        font-weight: 700;
        color: #d84315; /* Dark Red-Orange */
        background: #ffebee; /* Lightest Red */
        padding: 2px 4px;
        border-radius: 4px;
    }
    
    /* Ensure table headers for new fields are compact */
    #jobQueueTable th {
        font-size: 11px;
        padding: 8px 6px;
    }
    #jobQueueTable td {
        font-size: 13px;
        padding: 6px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
      <span id="sv_user_name"></span>
      <span id="liveTime"></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link active">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Job Queue</div>
          <div class="page-sub">Pending jobs with Turnaround Time (TAT) Tracking</div>
        </div>
      </div>

      <div class="grid-3">
        <div class="card" style="background:#eef3ff;">
          <h3>Total Active Jobs</h3>
          <div class="big" id="totalActiveJobs">0</div>
        </div>
        <div class="card" style="background:#fff3e0;">
          <h3>Total Pending TAT (Days)</h3>
          <div class="big" id="totalPendingTAT">0</div>
        </div>
        <div class="card" style="background:#ffebee;">
          <h3>Overdue Jobs</h3>
          <div class="big" id="overdueJobs">0</div>
        </div>
      </div>

      <div class="card">
        <h3>Active Jobs Queue</h3>
        <table class="table" id="jobQueueTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Manager</th>
              <th>Order Date</th>
              <th>Target Date</th>
              <th>Status</th>
              <th>Total TAT (Days)</th>
              <th>Pending TAT (Days)</th>
              <th>Amount (Rs.)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" class="muted">Loading job queue...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="card" style="margin-top: 15px;">
        <h3>Manager Pending TAT Summary</h3>
        <table class="table" id="managerSummaryTable">
            <thead>
                <tr>
                    <th>Manager Name</th>
                    <th>Pending Jobs</th>
                    <th>Total Pending TAT (Days)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="3" class="muted">Calculating summary...</td></tr>
            </tbody>
        </table>
      </div>
      
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // 1. Authentication Check
    checkAuth();
    
    // --- CONSTANTS ---
    const MS_PER_DAY = 1000 * 60 * 60 * 24;
    // TAT is 0 days (Same Day)
    const DEFAULT_TAT_DAYS = 0; 
    
    // --- Helper Functions ---
    
    // Utility to calculate the difference in full days between two dates (A - B)
    function dateDiffInDays(dateA, dateB) {
        if (!dateA || !dateB) return 0;
        
        const date1 = new Date(dateA);
        const date2 = new Date(dateB);
        
        // Reset time to midnight to ensure accurate day difference calculation
        date1.setUTCHours(0, 0, 0, 0);
        date2.setUTCHours(0, 0, 0, 0);
        
        const diffTime = date1.getTime() - date2.getTime();
        // Math.ceil is used to ensure partial days are counted as 1 day for remaining TAT
        return Math.ceil(diffTime / MS_PER_DAY); 
    }
    
    function loadLocalJobs() {
      return JSON.parse(localStorage.getItem('sv_jobs') || '[]');
    }
    
    function getStatusClass(status) {
      switch (status) {
        case 'Completed': return 'status-completed';
        case 'Working': return 'status-working';
        case 'Hold': return 'status-hold';
        default: return 'status-pending';
      }
    }
    
    // --- Main Rendering Logic ---
    function renderJobQueue() {
      const allJobs = loadLocalJobs();
      const tbody = document.querySelector('#jobQueueTable tbody');
      const summaryTbody = document.querySelector('#managerSummaryTable tbody');
      
      if (!tbody) return;
      tbody.innerHTML = '';
      
      const today = new Date().toISOString().slice(0, 10);
      // Only show jobs that are not 'Completed'
      const activeJobs = allJobs.filter(job => job.status !== 'Completed'); 

      let totalPendingTATDays = 0;
      let overdueCount = 0;
      const managerTATSummary = {}; // To store TAT per manager
      
      if (activeJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="muted">The Job Queue is empty! ðŸŽ‰</td></tr>';
      } else {
        
        // Sort by Order Date (Oldest/Overdue first)
        activeJobs.sort((a, b) => {
            return new Date(a.orderDate) - new Date(b.orderDate);
        });

        activeJobs.forEach(job => {
            // TARGET DATE IS THE SAME AS ORDER DATE
            job.targetCompletionDate = job.orderDate; 
            
            let pendingTATDays = 0;
            let tatClass = 'tat-ontime';
            
            if (job.status !== 'Hold') { 
                 // dateDiffInDays(Target Date (Order Date), Today's Date)
                 pendingTATDays = dateDiffInDays(job.targetCompletionDate, today); 

                 if (pendingTATDays < 0) {
                     // If target date is in the past, it's overdue
                     tatClass = 'tat-overdue';
                     overdueCount++;
                     // Overdue days is the absolute value of the diff
                     pendingTATDays = Math.abs(pendingTATDays); 
                 } else {
                     // If pendingTATDays is 0 or 1, it means the job is due today.
                     // Since the target IS the order date, if it's today or later, it means 0 days remaining.
                     pendingTATDays = 0;
                 }
            } else {
                // If on Hold, display 0 days pending
                pendingTATDays = 0;
            }
            
            // Update global TAT counter: only count OVERDUE days in this scenario.
            // If TAT is 0, the total pending TAT should reflect accumulated overdue days.
            if (job.status !== 'Hold' && tatClass === 'tat-overdue') {
                totalPendingTATDays += pendingTATDays;
            }


            // Update Manager TAT Summary
            const manager = job.assignedPerson;
            if (!managerTATSummary[manager]) {
                managerTATSummary[manager] = { pendingJobs: 0, totalPendingTAT: 0 };
            }
            managerTATSummary[manager].pendingJobs++;
            
            // Manager Pending TAT = only count overdue days
            if (job.status !== 'Hold' && tatClass === 'tat-overdue') {
                 managerTATSummary[manager].totalPendingTAT += pendingTATDays;
            }
            
            const row = document.createElement('tr');
            
            const pendingTATDisplay = tatClass === 'tat-overdue' 
                                      ? `<span class="${tatClass}">${pendingTATDays} Days Overdue!</span>`
                                      : (job.status === 'Hold' ? 'N/A (Hold)' : `<span class="tat-ontime">0 Days Remaining (Due Today)</span>`);
          
            row.innerHTML = `
              <td>#${job.id}</td>
              <td>${job.customer}</td>
              <td>${job.assignedPerson}</td>
              <td>${job.orderDate}</td>
              <td>${job.targetCompletionDate}</td>
              <td class="${getStatusClass(job.status)}">${job.status}</td>
              <td>${DEFAULT_TAT_DAYS} (Same Day)</td>
              <td>${pendingTATDisplay}</td>
              <td>â‚¹ ${job.amount}</td>
            `;
            tbody.appendChild(row);
        });
      }
      
      // Update Summary Cards
      document.getElementById('totalActiveJobs').textContent = activeJobs.length;
      document.getElementById('totalPendingTAT').textContent = totalPendingTATDays;
      document.getElementById('overdueJobs').textContent = overdueCount;
      
      // Update Manager Summary Table
      summaryTbody.innerHTML = '';
      const managerNames = Object.keys(managerTATSummary).sort();
      
      if (managerNames.length === 0) {
          summaryTbody.innerHTML = '<tr><td colspan="3" class="muted">No active managers found.</td></tr>';
      } else {
          managerNames.forEach(manager => {
              const summary = managerTATSummary[manager];
              const summaryRow = document.createElement('tr');
              summaryRow.innerHTML = `
                  <td>${manager}</td>
                  <td>${summary.pendingJobs}</td>
                  <td>${summary.totalPendingTAT} Days Overdue</td>
              `;
              summaryTbody.appendChild(summaryRow);
          });
      }
    }

    // Initialize the page
    document.addEventListener("DOMContentLoaded", renderJobQueue);

  </script>
</body>
</html>
