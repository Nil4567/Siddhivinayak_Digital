<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Job Queue — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    /* Job Queue specific styling here */
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link active">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="expenses.html" class="nav-link">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Job Queue</div>
          <div class="page-sub">All active and completed customer jobs.</div>
        </div>
      </div>

      <div class="card">
        <h3>All Jobs</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Description</th>
              <th>Amount (₹)</th>
              <th>Due (₹)</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="jobQueueTableBody">
            <tr><td colspan="9" style="text-align: center;">Loading job data...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    const ACCESS_PERMISSIONS = window.ACCESS_PERMISSIONS || {}; 
    const USER_ROLE = localStorage.getItem("sv_user_role");
    const USER_PERMISSIONS = JSON.parse(localStorage.getItem("sv_user_permissions") || "{}");
    
    // --- Job Queue Specific Functions ---
    function getStatusClass(status) {
        if (status === 'Pending') return 'status-pending';
        if (status === 'Completed') return 'status-completed';
        if (status === 'Cancelled') return 'status-cancelled';
        return 'status-default';
    }
    
    function changeStatus(jobId, newStatus) {
        // Check if user has the 'manage' permission for job queue
        const canManage = USER_PERMISSIONS['job_queue'] && USER_PERMISSIONS['job_queue'].includes('manage');
        
        if (!canManage) {
            alert("Permission denied. You do not have 'manage' rights for the Job Queue.");
            return;
        }

        if (!confirm(`Are you sure you want to change Job ${jobId} status to "${newStatus}"?`)) { return; }

        let allJobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
        const jobIndex = allJobs.findIndex(job => job.id === jobId);

        if (jobIndex > -1) {
            allJobs[jobIndex].status = newStatus;
            
            if (newStatus === 'Completed') {
                allJobs[jobIndex].pendingAmount = '0';
            }
            
            localStorage.setItem('sv_jobs', JSON.stringify(allJobs));
            renderJobQueue(); 
            alert(`Job ${jobId} status updated to ${newStatus}.`);
        }
    }

    function renderJobQueue() {
        // FIX: Ensure you are initializing sv_jobs if it's empty to prevent parse errors
        const allJobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
        const tableBody = document.getElementById('jobQueueTableBody');
        tableBody.innerHTML = '';
        
        allJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        if (allJobs.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No jobs found. Enter a new job to start the queue.</td></tr>';
            return;
        }

        const canManage = USER_PERMISSIONS['job_queue'] && USER_PERMISSIONS['job_queue'].includes('manage');

        allJobs.forEach(job => {
            const row = tableBody.insertRow();
            
            let actionButtons = '';
            if (canManage && job.status === 'Pending') {
                actionButtons = `<button class="btn accent btn-small" onclick="changeStatus('${job.id}', 'Completed')">Complete</button>`;
            } else if (job.status === 'Completed') {
                actionButtons = `<span style="color: var(--accent); font-size: 12px; font-weight: 600;">Finalized</span>`;
            } else {
                 actionButtons = `<span style="color: var(--muted); font-size: 12px;">View Only</span>`;
            }

            row.innerHTML = `
                <td>${job.id}</td>
                <td>${job.orderDate}</td>
                <td>${job.customer}</td>
                <td>${job.description.substring(0, 40)}...</td>
                <td>₹ ${job.amount}</td>
                <td>₹ ${job.pendingAmount}</td>
                <td>${job.assignedPerson || 'N/A'}</td>
                <td><span class="status-badge ${getStatusClass(job.status)}">${job.status}</span></td>
                <td>${actionButtons}</td>
            `;
        });
    }
    
    window.changeStatus = changeStatus; 

    // --- Initialization and Role-Based Access Filter ---
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth(); 
        
        // Check if there's any job data to render
        renderJobQueue();
        
        // Hide sidebar links based on user's current permissions
        const userPermissions = JSON.parse(localStorage.getItem("sv_user_permissions") || "{}");
        const features = ACCESS_PERMISSIONS.features;

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            const href = link.getAttribute('href');
            const pageName = href ? href.split('/').pop() : '';

            const featureKey = Object.keys(features).find(key => 
                features[key].page === pageName
            );

            const hasViewPermission = userPermissions[featureKey] && userPermissions[featureKey].includes('view');

            if (!hasViewPermission) {
                link.style.display = 'none';
            }
        });
    });
  </script>
</body>
</html>
