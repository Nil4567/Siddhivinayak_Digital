<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Customers â€” Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link active">Customers</a>
      <a href="expenses.html" class="nav-link">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">Customer List</div>
          <div class="page-sub">All unique customers from job entries</div>
        </div>
      </div>

      <div class="card">
        <h3>Customer Details</h3>
        <table class="data-table" id="customerTable">
          <thead>
            <tr>
                <th>Customer Name</th>
                <th>Contact Number</th>
                <th>Email ID</th>
                <th>Total Jobs</th>
                <th>Last Job ID</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align: center;">Loading customers...</td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // Global variables populated by script.js after checkAuth()
    const ACCESS_PERMISSIONS = window.ACCESS_PERMISSIONS || {};
    const USER_PERMISSIONS = JSON.parse(localStorage.getItem("sv_user_permissions") || "{}");
    
    function loadLocalJobs() {
      // Loads job data from the browser's local storage
      return JSON.parse(localStorage.getItem('sv_jobs') || '[]');
    }

    function renderCustomers() {
      // Only proceed if the user has at least 'view' permission for this feature
      const canView = USER_PERMISSIONS['customers'] && USER_PERMISSIONS['customers'].includes('view');
      if (!canView) {
           document.querySelector('#customerTable tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--danger);">Access Denied.</td></tr>';
           return;
      }
        
      const allJobs = loadLocalJobs();
      const tbody = document.querySelector('#customerTable tbody');
      
      if (!tbody) return;
      tbody.innerHTML = '';

      if (allJobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted);">No customers found.</td></tr>';
        return;
      }
      
      // Use a Map to consolidate customer data based on a unique key
      const customersMap = new Map(); // Key: customer name + contact

      allJobs.forEach(job => {
        // Normalize customer name and use contact number for unique identification
        const key = `${job.customer.trim().toLowerCase()}||${job.contact}`;
        
        if (customersMap.has(key)) {
          const customerData = customersMap.get(key);
          customerData.totalJobs++;
          // Update last job ID if the current job is newer
          if (new Date(job.createdAt) > new Date(customerData.lastJobCreatedAt)) {
            customerData.lastJobId = job.id;
            customerData.lastJobCreatedAt = job.createdAt;
          }
        } else {
          customersMap.set(key, {
            name: job.customer,
            contact: job.contact,
            // Assuming email field might be added later, currently defaults to N/A
            email: job.customerEmail || 'N/A', 
            totalJobs: 1,
            lastJobId: job.id,
            lastJobCreatedAt: job.createdAt
          });
        }
      });
      
      // Convert Map values to an array and sort by customer name
      const uniqueCustomers = Array.from(customersMap.values()).sort((a, b) => a.name.localeCompare(b.name));

      uniqueCustomers.forEach(customer => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${customer.name}</td>
          <td>${customer.contact || 'N/A'}</td>
          <td>${customer.email}</td>
          <td>${customer.totalJobs}</td>
          <td><span style="font-weight:700;">#${customer.lastJobId}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    // --- Initialization and Role-Based Access Filter (CORRECTED LOGIC) ---
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth(); // 1. Run Auth & Access Check
        
        // 2. Run page rendering function
        renderCustomers(); 
        
        // 3. Hide sidebar links based on user's current permissions
        const features = ACCESS_PERMISSIONS.features;
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            const href = link.getAttribute('href');
            const pageName = href ? href.split('/').pop() : '';

            // Find the feature key (e.g., 'dashboard', 'customers') corresponding to the pageName
            const featureKey = Object.keys(features).find(key => 
                features[key].page === pageName
            );

            // Check if the user has 'view' access for this feature
            const hasViewPermission = USER_PERMISSIONS[featureKey] && USER_PERMISSIONS[featureKey].includes('view');

            if (featureKey && !hasViewPermission) {
                link.style.display = 'none';
            }
        });
    });
  </script>
</body>
</html>
