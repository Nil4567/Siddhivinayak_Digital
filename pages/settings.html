<script src="../script.js"></script>
<script>
    // Access global functions from script.js
    const addNewUser = window.addNewUser;
    const getUserCredentials = window.getUserCredentials;
    const ACCESS_PERMISSIONS = window.ACCESS_PERMISSIONS; // Get access definitions
    
    // --- Utility Functions ---
    
    function populateAccessTemplates() {
        const select = document.getElementById('accessTemplate');
        select.innerHTML = '<option value="">-- Select Template --</option>';

        // Iterate over roles defined in ACCESS_PERMISSIONS (excluding 'features')
        const roles = Object.keys(ACCESS_PERMISSIONS).filter(key => key !== 'features');
        
        roles.forEach(roleKey => {
            const option = document.createElement('option');
            option.value = roleKey;
            
            // Create a friendly label
            let label = roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
            if (roleKey === 'admin') label += ' (Full Access)';
            if (roleKey === 'manager') label += ' (Manage Jobs, View Expenses)';
            if (roleKey === 'viewer') label += ' (View Jobs)';
            
            option.textContent = label;
            select.appendChild(option);
        });
    }

    function displayCurrentUsers() {
        const users = getUserCredentials();
        const container = document.getElementById('currentUsersList'); // Assuming an element with this ID exists
        
        if (!container) return;
        
        container.innerHTML = '<table></table>'; // Clear and start table
        const table = container.querySelector('table');
        table.className = 'data-table';
        
        // Table Header
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Full Name</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Permissions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');

        users.forEach(user => {
            const row = tbody.insertRow();
            
            // Format permissions summary (e.g., Dashboard(view), Job Entry(manage, view)...)
            const permissionsSummary = Object.entries(user.permissions || {})
                .map(([feature, actions]) => {
                    return actions.length > 0 ? `${ACCESS_PERMISSIONS.features[feature].label} (${actions.join(', ')})` : null;
                })
                .filter(Boolean)
                .join(' | ');

            row.innerHTML = `
                <td>${user.name}</td>
                <td>${user.username}</td>
                <td><span class="role-${user.role}">${user.role.toUpperCase()}</span></td>
                <td title="${permissionsSummary}">${user.role === 'admin' ? 'FULL SYSTEM ACCESS' : permissionsSummary.substring(0, 50) + '...'}</td>
            `;
        });
    }

    // --- Form Submission Handler ---
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const newUserDetails = {
            name: form.userFullName.value.trim(),
            username: form.loginUsername.value.trim(),
            password: form.password.value,
            role: form.accessTemplate.value
        };

        if (!newUserDetails.name || !newUserDetails.username || !newUserDetails.password || !newUserDetails.role) {
            alert("Please fill in all required fields.");
            return;
        }

        const success = addNewUser(newUserDetails);

        if (success) {
            alert(`User '${newUserDetails.name}' added successfully!`);
            form.reset();
            displayCurrentUsers(); // Refresh the list
        } else {
            alert(`Error: Username '${newUserDetails.username}' already exists. Please choose a different username.`);
        }
    });

    // --- Initialization ---
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth(); // From script.js: Checks login/access and initializes header/sidebar
        populateAccessTemplates();
        displayCurrentUsers();
        
        // Ensure the correct sub-menu item is active (User Management)
        document.querySelectorAll('.settings-menu a').forEach(a => {
            a.classList.remove('active');
        });
        document.getElementById('userManagementLink').classList.add('active'); // You may need to add an ID to your link
    });
</script>
