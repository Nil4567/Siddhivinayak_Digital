<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>User Management & Settings â€” Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .settings-grid .card {
            padding: 20px;
        }
        .field {
            margin-bottom: 20px;
        }
        .field label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        .btn-save {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            font-size: 1.05em;
        }
        .note {
            font-size: 0.9em;
            color: var(--info);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link active">User Management</a>
            </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">User Management & Global Settings</div>
                    <div class="page-sub">Define authorized users and managers for the application.</div>
                </div>
            </div>

            <div class="settings-grid">
                <div class="card">
                    <form id="userSettingsForm">
                        <div class="field">
                            <label for="managerList">Managers List (One name per line)</label>
                            <textarea id="managerList" required placeholder="Enter the names of all managers who can be assigned jobs.&#10;e.g.,&#10;Amit Sharma&#10;Priya Yadav"></textarea>
                            <div class="note">These names will populate the "Manager" dropdown on the New Job Entry form.</div>
                        </div>

                        <div class="field">
                            <label for="allUsersList">All Authorized Users (Username:Password - One per line)</label>
                            <textarea id="allUsersList" required placeholder="Enter all authorized users with their passwords.&#10;e.g.,&#10;admin:123456&#10;user1:password123&#10;amit:amit@123"></textarea>
                            <div class="note">These users can log in. User credentials are now stored in the Google Sheet.</div>
                        </div>

                        <button type="submit" class="btn btn-save" id="saveButton">Save Settings</button>
                        <p id="saveMessage" style="color: var(--success); margin-top: 10px; display: none;">Settings saved successfully!</p>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Access global functions from script.js
        checkAuth = window.checkAuth;
        saveUserSettingsToSheet = window.saveUserSettingsToSheet; 
        
        const managerListInput = document.getElementById('managerList');
        const allUsersListInput = document.getElementById('allUsersList');
        const userSettingsForm = document.getElementById('userSettingsForm');
        const saveButton = document.getElementById('saveButton');
        const saveMessage = document.getElementById('saveMessage');

        // Local Storage Keys for loading (we still use Local Storage to quickly fetch manager list)
        const MANAGER_KEY = 'managersList';
        const USERS_KEY = 'usersCredentials'; // Retained for backwards compatibility if needed

        /**
         * Loads settings from Local Storage (for manager dropdown) and logs in credentials 
         * (which will soon be obsolete, but we keep it for fallback).
         */
        function loadSettings() {
            // Managers List: Still loaded locally, but saved to the Sheet as well
            const managersJSON = localStorage.getItem(MANAGER_KEY);
            if (managersJSON) {
                try {
                    const managers = JSON.parse(managersJSON);
                    managerListInput.value = managers.join('\n');
                } catch (e) {
                    managerListInput.value = '';
                }
            } else {
                 managerListInput.value = 'Amit Sharma\nPriya Yadav'; // Default
            }

            // All Users List: Since saving is now to the sheet, we load defaults for initial setup
            // NOTE: The user list should ideally be fetched from the Google Sheet via a GET request
            // but we use defaults here to allow initial setup via the settings page.
            allUsersListInput.value = 'admin:admin123\nmanager:manager123';
        }

        /**
         * Handles form submission to save settings to the Google Sheet.
         */
        userSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            saveButton.disabled = true;
            saveMessage.style.display = 'none';
            saveMessage.style.color = 'var(--success)';

            // 1. Process Managers List
            const managerLines = managerListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Save managers list locally for IMMEDIATE use in the Job Entry dropdown
            localStorage.setItem(MANAGER_KEY, JSON.stringify(managerLines)); 

            // 2. Process All Users List (Username:Password)
            const userLines = allUsersListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            const userMap = {};
            let parseError = false;

            userLines.forEach(line => {
                const parts = line.split(':');
                if (parts.length === 2) {
                    const username = parts[0].trim();
                    const password = parts[1].trim();
                    if (username && password) {
                        userMap[username] = password;
                    }
                } else {
                    parseError = true;
                }
            });

            if (parseError) {
                alert("Warning: Some user lines were not in the 'username:password' format and were ignored.");
            }
            
            // Prepare the data to send to the Google Sheet
            const settingsData = {
                managers: managerLines,
                users: Object.entries(userMap).map(([user, pass]) => ({ username: user, password: pass }))
            };

            try {
                // Call the new global function to send data to the script
                const success = await saveUserSettingsToSheet(settingsData); 

                if (success) {
                    saveMessage.textContent = 'Settings and User Credentials saved to Google Sheet successfully!';
                    saveMessage.style.display = 'block';
                } else {
                    // saveUserSettingsToSheet will alert the failure, just update the message here
                    saveMessage.textContent = 'ERROR: Submission failed. Check script credentials.';
                    saveMessage.style.color = 'var(--danger)';
                    saveMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Settings submission failed:", error);
                saveMessage.textContent = 'CRITICAL NETWORK ERROR. Could not reach the Apps Script.';
                saveMessage.style.color = 'var(--danger)';
                saveMessage.style.display = 'block';
            }

            saveButton.disabled = false;
            
            // Clear message after a short delay
            setTimeout(() => {
                saveMessage.style.display = 'none';
            }, 5000);
        });


        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            // checkAuth() MUST be called first to ensure the user is logged in
            if (typeof checkAuth === 'function') {
                 checkAuth(); 
            } else {
                 console.error("checkAuth function is missing from script.js");
            }
            
            loadSettings(); 
        });
    </script>
</body>
</html>
