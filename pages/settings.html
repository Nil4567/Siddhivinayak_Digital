<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>User Management â€” Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        /* New CSS for the User Management layout */
        .user-management-grid {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Make the list section wider than the form */
            gap: 30px;
            padding: 20px;
            align-items: start;
        }
        .add-user-section {
            max-width: 400px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9em;
        }
        .data-table th {
            background-color: var(--highlight);
            font-weight: bold;
        }
        /* Custom styles for role tags */
        .role-admin { color: var(--danger); }
        .role-manager { color: var(--primary); }
        .role-viewer { color: var(--success); }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link active">User Management</a> <a href="admin-credentials.html" class="nav-link">Admin Credentials</a>
        </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">User & Access Management</div>
                    <div class="page-sub">Add new users and manage their login credentials and specific menu permissions.</div>
                </div>
            </div>

            <div class="user-management-grid">
                
                <div class="card add-user-section">
                    <h3>Add New User</h3>
                    <form id="addUserForm">
                        <div class="field">
                            <label for="userFullName">User's Full Name *</label>
                            <input type="text" id="userFullName" name="userFullName" required placeholder="e.g., Pooja Singh">
                        </div>
                        
                        <div class="field">
                            <label for="loginUsername">Login Username *</label>
                            <input type="text" id="loginUsername" name="loginUsername" required placeholder="e.g., pooja.s">
                        </div>
                        
                        <div class="field">
                            <label for="password">Password *</label>
                            <input type="password" id="password" name="password" required placeholder="e.g., pass123">
                        </div>
                        
                        <div class="field">
                            <label for="accessTemplate">Access Template *</label>
                            <select id="accessTemplate" name="accessTemplate" required>
                                </select>
                        </div>
                        
                        <button type="submit" class="btn full-width">Add User</button>
                    </form>
                </div>
                
                <div class="card current-users-section">
                    <h3>Current Active Users & Credentials</h3>
                    <div id="currentUsersList">
                        <p>Loading user list...</p>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Access global functions from script.js
        const addNewUser = window.addNewUser;
        const getUserCredentials = window.getUserCredentials;
        const ACCESS_PERMISSIONS = window.ACCESS_PERMISSIONS; // Get access definitions
        
        // --- Utility Functions ---
        
        function populateAccessTemplates() {
            const select = document.getElementById('accessTemplate');
            select.innerHTML = '<option value="">-- Select Template --</option>';

            // Iterate over roles defined in ACCESS_PERMISSIONS (excluding 'features')
            const roles = Object.keys(ACCESS_PERMISSIONS).filter(key => key !== 'features');
            
            roles.forEach(roleKey => {
                const option = document.createElement('option');
                option.value = roleKey;
                
                // Create a friendly label
                let label = roleKey.charAt(0).toUpperCase() + roleKey.slice(1);
                if (roleKey === 'admin') label += ' (Full Access)';
                if (roleKey === 'manager') label += ' (Manage Jobs, View Expenses)';
                if (roleKey === 'viewer') label += ' (View Jobs)';
                
                option.textContent = label;
                select.appendChild(option);
            });
        }

        function displayCurrentUsers() {
            const users = getUserCredentials();
            const container = document.getElementById('currentUsersList');
            
            if (!container) return;
            
            container.innerHTML = '<table></table>'; 
            const table = container.querySelector('table');
            table.className = 'data-table';
            
            // Table Header
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Full Name</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Permissions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            users.forEach(user => {
                const row = tbody.insertRow();
                
                // Format permissions summary
                const permissionsSummary = Object.entries(user.permissions || {})
                    .map(([feature, actions]) => {
                        const featureLabel = ACCESS_PERMISSIONS.features[feature] ? ACCESS_PERMISSIONS.features[feature].label : feature;
                        return actions.length > 0 ? `${featureLabel} (${actions.join(', ')})` : null;
                    })
                    .filter(Boolean)
                    .join(' | ');

                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td><span class="role-${user.role}">${user.role.toUpperCase()}</span></td>
                    <td title="${permissionsSummary}">${user.role === 'admin' ? 'FULL SYSTEM ACCESS' : permissionsSummary.substring(0, 50) + '...'}</td>
                `;
            });
        }

        // --- Form Submission Handler ---
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const newUserDetails = {
                name: form.userFullName.value.trim(),
                username: form.loginUsername.value.trim(),
                password: form.password.value,
                role: form.accessTemplate.value
            };

            if (!newUserDetails.name || !newUserDetails.username || !newUserDetails.password || !newUserDetails.role) {
                alert("Please fill in all required fields.");
                return;
            }

            const success = addNewUser(newUserDetails);

            if (success) {
                alert(`User '${newUserDetails.name}' added successfully!`);
                form.reset();
                displayCurrentUsers(); // Refresh the list
            } else {
                alert(`Error: Username '${newUserDetails.username}' already exists. Please choose a different username.`);
            }
        });

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            checkAuth(); 
            populateAccessTemplates();
            displayCurrentUsers();
            
            // Since this page is now the main User Management page, no need for sub-menu activation
        });
    </script>
</body>
</html>
