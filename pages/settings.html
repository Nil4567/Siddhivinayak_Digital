// Handle form submission inside the modal (Add/Edit)
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const username = modalUsername.value.trim();
            const password = modalPassword.value.trim();
            const isManager = modalIsManager.checked;
            
            // Basic validation
            if (!username || !password) {
                alert('Username and Password are required.');
                return;
            }
            
            // Prepare the new/updated user object
            const updatedUser = { username, password, isManager };
            
            // Check if user already exists (for "Edit" mode)
            const existingIndex = currentUsers.findIndex(u => u.username === username);

            if (existingIndex !== -1) {
                // --- FIX: Edit existing user (Update the item in place) ---
                // If it's an edit, we update the existing object
                currentUsers[existingIndex] = updatedUser;
                alert(`User ${username} updated successfully.`);
            } else {
                // --- FIX: Add new user (Push to the array) ---
                // Check for duplicates before adding a NEW user
                if (currentUsers.some(u => u.username === username)) {
                    alert('Error: A user with this username already exists!');
                    return;
                }
                currentUsers.push(updatedUser);
                alert(`New user ${username} added successfully.`);
            }
            
            closeModal();
            // Call the function to send the entire master list to the Google Sheet
            submitMasterList(); 
        });
