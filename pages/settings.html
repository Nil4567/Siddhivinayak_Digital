<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>User Management & Settings â€” Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        .settings-grid .card {
            padding: 20px;
        }
        .field {
            margin-bottom: 20px;
        }
        .field label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        textarea {
            resize: vertical;
            min-height: 120px;
        }
        .btn-save {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            font-size: 1.05em;
        }
        .note {
            font-size: 0.9em;
            color: var(--info);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link active">User Management</a>
            <a href="admin-credentials.html" class="nav-link">Admin Credentials</a>
        </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">User Management & Global Settings</div>
                    <div class="page-sub">Define authorized users and managers for the application.</div>
                </div>
            </div>

            <div class="settings-grid">
                <div class="card">
                    <form id="userSettingsForm">
                        <div class="field">
                            <label for="managerList">Managers List (One name per line)</label>
                            <textarea id="managerList" required placeholder="Enter the names of all managers who can be assigned jobs.&#10;e.g.,&#10;Amit Sharma&#10;Priya Yadav"></textarea>
                            <div class="note">These names will populate the "Manager" dropdown on the New Job Entry form.</div>
                        </div>

                        <div class="field">
                            <label for="allUsersList">All Authorized Users (Username:Password - One per line)</label>
                            <textarea id="allUsersList" required placeholder="Enter all authorized users with their passwords.&#10;e.g.,&#10;admin:123456&#10;user1:password123&#10;amit:amit@123"></textarea>
                            <div class="note">These users can log in. Only users in the Managers List can be assigned jobs.</div>
                        </div>

                        <button type="submit" class="btn btn-save" id="saveButton">Save Settings</button>
                        <p id="saveMessage" style="color: var(--success); margin-top: 10px; display: none;">Settings saved successfully!</p>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        const managerListInput = document.getElementById('managerList');
        const allUsersListInput = document.getElementById('allUsersList');
        const userSettingsForm = document.getElementById('userSettingsForm');
        const saveButton = document.getElementById('saveButton');
        const saveMessage = document.getElementById('saveMessage');

        // Local Storage Keys
        const MANAGER_KEY = 'managersList';
        const USERS_KEY = 'usersCredentials';

        /**
         * Loads settings from Local Storage and populates the text areas.
         */
        function loadSettings() {
            // Load Managers List
            const managersJSON = localStorage.getItem(MANAGER_KEY);
            if (managersJSON) {
                try {
                    const managers = JSON.parse(managersJSON);
                    managerListInput.value = managers.join('\n');
                } catch (e) {
                    console.error("Error parsing stored managers list:", e);
                }
            }

            // Load All Users List
            const usersJSON = localStorage.getItem(USERS_KEY);
            if (usersJSON) {
                try {
                    const users = JSON.parse(usersJSON);
                    // Convert map of {user: pass} to the "user:pass" string format
                    const userLines = Object.entries(users).map(([user, pass]) => `${user}:${pass}`);
                    allUsersListInput.value = userLines.join('\n');
                } catch (e) {
                    console.error("Error parsing stored user credentials:", e);
                }
            }
        }

        /**
         * Handles form submission to save settings to Local Storage.
         */
        userSettingsForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveButton.disabled = true;
            saveMessage.style.display = 'none';

            // 1. Process Managers List
            const managerLines = managerListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            localStorage.setItem(MANAGER_KEY, JSON.stringify(managerLines));

            // 2. Process All Users List (Username:Password)
            const userLines = allUsersListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            const userMap = {};
            let parseError = false;

            userLines.forEach(line => {
                const parts = line.split(':');
                if (parts.length === 2) {
                    const username = parts[0].trim();
                    const password = parts[1].trim();
                    if (username && password) {
                        userMap[username] = password;
                    }
                } else {
                    parseError = true;
                }
            });

            if (parseError) {
                alert("Warning: Some user lines were not in the 'username:password' format and were ignored.");
            }
            
            localStorage.setItem(USERS_KEY, JSON.stringify(userMap));

            saveButton.disabled = false;
            saveMessage.textContent = 'Settings saved successfully!';
            saveMessage.style.display = 'block';
            
            // Re-load to confirm data integrity
            loadSettings();

            // Clear message after a short delay
            setTimeout(() => {
                saveMessage.style.display = 'none';
            }, 3000);
        });


        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            checkAuth(); // Check for login status
            loadSettings(); // Load existing configuration
        });
    </script>
</body>
</html>
