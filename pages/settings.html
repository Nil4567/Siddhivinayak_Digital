<script src="../script.js"></script>
    <script>
        // We will define a new global function for saving user data in script.js later
        saveUserSettingsToSheet = window.saveUserSettingsToSheet; 
        
        const managerListInput = document.getElementById('managerList');
        const allUsersListInput = document.getElementById('allUsersList');
        const userSettingsForm = document.getElementById('userSettingsForm');
        const saveButton = document.getElementById('saveButton');
        const saveMessage = document.getElementById('saveMessage');

        // Local Storage Keys for loading (we will still load, but saving goes to the sheet)
        const MANAGER_KEY = 'managersList';
        const USERS_KEY = 'usersCredentials';

        /**
         * Loads settings from Local Storage (for manager dropdown) and logs in credentials 
         * (which will soon be obsolete, but we keep it for fallback).
         */
        function loadSettings() {
            // Managers List: Still loaded locally, but saved to the Sheet as well
            const managersJSON = localStorage.getItem(MANAGER_KEY);
            if (managersJSON) {
                try {
                    const managers = JSON.parse(managersJSON);
                    managerListInput.value = managers.join('\n');
                } catch (e) {
                    managerListInput.value = '';
                }
            } else {
                 managerListInput.value = 'Amit Sharma\nPriya Yadav'; // Default
            }

            // All Users List: Since saving is now to the sheet, we load defaults for initial setup
            allUsersListInput.value = 'admin:admin123\nuser1:password123';
            // NOTE: Once the first user data is submitted, this page should be updated 
            // to fetch the current user list from the Google Sheet via a GET request.
        }

        /**
         * Handles form submission to save settings to the Google Sheet.
         */
        userSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            saveButton.disabled = true;
            saveMessage.style.display = 'none';
            saveMessage.style.color = 'var(--success)';

            // 1. Process Managers List
            const managerLines = managerListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            // Save managers list locally for IMMEDIATE use in the Job Entry dropdown
            localStorage.setItem(MANAGER_KEY, JSON.stringify(managerLines)); 

            // 2. Process All Users List (Username:Password)
            const userLines = allUsersListInput.value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            const userMap = {};
            let parseError = false;

            userLines.forEach(line => {
                const parts = line.split(':');
                if (parts.length === 2) {
                    const username = parts[0].trim();
                    const password = parts[1].trim();
                    if (username && password) {
                        userMap[username] = password;
                    }
                } else {
                    parseError = true;
                }
            });

            if (parseError) {
                alert("Warning: Some user lines were not in the 'username:password' format and were ignored.");
            }
            
            // Prepare the data to send to the Google Sheet
            const settingsData = {
                managers: managerLines,
                users: Object.entries(userMap).map(([user, pass]) => ({ username: user, password: pass }))
            };

            try {
                // Call the new global function to send data to the script
                const success = await saveUserSettingsToSheet(settingsData); 

                if (success) {
                    saveMessage.textContent = 'Settings and User Credentials saved to Google Sheet successfully!';
                    saveMessage.style.display = 'block';
                } else {
                    // saveUserSettingsToSheet will alert the failure, just update the message here
                    saveMessage.textContent = 'ERROR: Submission failed. Check script credentials.';
                    saveMessage.style.color = 'var(--danger)';
                    saveMessage.style.display = 'block';
                }
            } catch (error) {
                console.error("Settings submission failed:", error);
                saveMessage.textContent = 'CRITICAL NETWORK ERROR. Could not reach the Apps Script.';
                saveMessage.style.color = 'var(--danger)';
                saveMessage.style.display = 'block';
            }


            saveButton.disabled = false;
            
            // Clear message after a short delay
            setTimeout(() => {
                saveMessage.style.display = 'none';
            }, 5000);
        });


        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            checkAuth(); 
            loadSettings(); 
        });
    </script>
