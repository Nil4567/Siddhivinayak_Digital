<script>
    // Run this function after checkAuth() has ensured the user is logged in
    document.addEventListener("DOMContentLoaded", function() {
        // --- Access Control Navigation Filter ---
        const userRole = localStorage.getItem("sv_user_role");
        const allowedPages = ACCESS_PERMISSIONS[userRole] || [];
        
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                const pageName = href.split('/').pop();
                
                // Hide the link if the current role doesn't have permission
                if (!allowedPages.includes(pageName)) {
                    link.style.display = 'none';
                }
            }
        });
    });
</script>
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Reports</title><link rel="stylesheet" href="../styles/internal.css"></head>
<body>
  <div class="topbar"><div class="brand">Siddhivinayak Digital</div><div class="controls"><div id="sv_user_name"></div><button class="btn" onclick="logout()">Logout</button></div></div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Reports</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="reports.html" class="nav-link active">Reports</a>
    </aside>

    <main class="main">
      <div class="page-header"><div><div class="page-title">Reports & Exports</div><div class="page-sub">Generate daily summary & export CSV</div></div></div>

      <div class="card">
        <h3>Quick Export</h3>
        <p>Click to download current jobs as CSV (from local data)</p>
        <div style="display:flex;gap:10px">
          <button class="btn" onclick="exportJobsCSV()">Export Jobs (CSV)</button>
        </div>
      </div>

    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    checkAuth();

    function exportJobsCSV(){
      const jobs = JSON.parse(localStorage.getItem('sv_jobs')||'[]');
      if(jobs.length===0){ alert('No jobs to export'); return; }
      const keys = ['id','date','customer','jobType','qty','department','status','createdAt','updatedAt'];
      const csv = [keys.join(',')].concat(jobs.map(j=> keys.map(k=> `"${(j[k]||'').toString().replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'jobs_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
