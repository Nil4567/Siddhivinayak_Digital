<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>New Job Entry — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
      <span id="sv_user_name"></span>
      <span id="liveTime"></span>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link active">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="departments.html" class="nav-link">Departments</a>
      <a href="materials.html" class="nav-link">Materials</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">New Job Entry</div>
          <div class="page-sub">Enter details for a new print or design request</div>
        </div>
      </div>

      <div class="card">
        <form id="jobEntryForm">
          
          <div id="alertMessage" style="display:none; padding:12px; margin-bottom:15px; border-radius:8px; font-weight:700; background:#d4edda; color:#155724;"></div>

          <div class="form-row">
            <div class="field">
              <label for="customerName">Customer Name</label>
              <input type="text" id="customerName" name="customerName" required>
            </div>
            <div class="field">
              <label for="customerContact">Contact Number</label>
              <input type="number" id="customerContact" name="customerContact" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="field">
              <label for="jobType">Job Type</label>
              <select id="jobType" name="jobType" required>
                <option value="">Select Type...</option>
                <option value="Color Print">Color Print</option>
                <option value="B/W Print">B/W Print</option>
                <option value="Design">Design</option>
                <option value="Binding">Binding</option>
                <option value="Lamination">Lamination</option>
                <option value="Scanning">Scanning</option>
              </select>
            </div>
            <div class="field">
              <label for="quantity">Quantity / Pages</label>
              <input type="number" id="quantity" name="quantity" min="1" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="field full-width">
              <label for="jobDescription">Job Description / Instructions</label>
              <textarea id="jobDescription" name="jobDescription" rows="3" required></textarea>
            </div>
          </div>
          
          <div class="form-row">
            <div class="field">
              <label for="assignedDept">Assigned Department</label>
              <select id="assignedDept" name="assignedDept" required>
                <option value="">Select Department...</option>
                <option value="Printing">Printing</option>
                <option value="Designing">Designing</option>
                <option value="Finishing">Finishing (Binding/Lamination)</option>
              </select>
            </div>
            <div class="field">
              <label for="assignedTo">Assigned To (Staff Name)</label>
              <input type="text" id="assignedTo" name="assignedTo">
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="urgency">Urgency</label>
              <select id="urgency" name="urgency">
                <option value="Normal">Normal</option>
                <option value="Express">Express (Urgent)</option>
              </select>
            </div>
            <div class="field">
              <label for="expectedDelivery">Expected Delivery Date</label>
              <input type="date" id="expectedDelivery" name="expectedDelivery" required>
            </div>
          </div>
          
          <button type="submit" class="btn" style="width:100%; margin-top:15px; padding:12px;">Submit New Job</button>
        </form>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // 1. Authentication Check
    checkAuth();

    // 2. Job Submission Logic
    async function submitJob(event) {
      event.preventDefault(); // Stop the page from reloading

      const form = document.getElementById('jobEntryForm');
      const alertEl = document.getElementById('alertMessage');
      
      if (!form.checkValidity()) {
          form.reportValidity(); // Show native browser errors
          return;
      }

      const existingJobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');

      // 3. Generate a simple unique ID
      const lastJob = existingJobs.length > 0 ? existingJobs[existingJobs.length - 1] : null;
      const nextId = lastJob && lastJob.id ? parseInt(lastJob.id) + 1 : 1001;
      const jobId = String(nextId);

      // 4. Construct the job data object
      const newJob = {
        id: jobId,
        customer: form.customerName.value,
        contact: form.customerContact.value,
        type: form.jobType.value,
        quantity: form.quantity.value,
        description: form.jobDescription.value,
        department: form.assignedDept.value,
        assignedTo: form.assignedTo.value || 'Unassigned',
        urgency: form.urgency.value,
        deliveryDate: form.expectedDelivery.value,
        status: 'Pending',
        createdAt: new Date().toISOString(),
        createdBy: localStorage.getItem('username') || 'Staff'
      };

      // 5. Store the new job locally
      existingJobs.push(newJob);
      localStorage.setItem('sv_jobs', JSON.stringify(existingJobs));

      // 6. Dispatch to GitHub (using the function from script.js)
      let success = false;
      try {
          success = await saveJobToGitHub(newJob); // This call is asynchronous
      } catch (e) {
          console.error("Error during GitHub dispatch:", e);
      }

      // 7. Display Result and Clean Up
      if (success) {
        alertEl.textContent = `✅ Success! Job #${jobId} saved and dispatched to GitHub workflow.`;
        alertEl.style.backgroundColor = '#d4edda';
        alertEl.style.color = '#155724';
      } else {
        alertEl.textContent = `⚠️ Warning: Job #${jobId} saved locally but GitHub dispatch failed. Check the browser console (F12).`;
        alertEl.style.backgroundColor = '#fff3cd';
        alertEl.style.color = '#856404';
      }

      alertEl.style.display = 'block';
      form.reset(); // Clear form fields
      
      setTimeout(() => {
        alertEl.style.display = 'none';
      }, 5000);
    }
    
    // Attach the submit handler to the form
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("jobEntryForm");
      if (form) {
        form.addEventListener("submit", submitJob);
      }
    });

  </script>
</body>
</html>
