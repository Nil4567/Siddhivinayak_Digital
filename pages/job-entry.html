<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>New Job Entry — Siddhivinayak Digital</title>
    <link rel="stylesheet" href="../styles/internal.css">
    <style>
        .job-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .field {
            margin-bottom: 15px;
        }
        .field label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .calculation-display {
            padding: 15px;
            background-color: var(--highlight);
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
            border-left: 5px solid var(--primary);
        }
        .calculation-display span {
            float: right;
            color: var(--danger);
        }
        .calculation-display .balance-positive {
            color: var(--success);
        }
        
        .btn-submit {
            background-color: var(--primary);
            color: white;
            font-size: 1.1em;
            padding: 10px 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand">Siddhivinayak Digital</div>
        <div class="controls">
            <button class="btn secondary" onclick="history.back()">Back</button>
            <a href="../index.html" class="btn secondary">Home</a>
            <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
            <span id="liveTime"></span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand-small">Control Panel</div>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="job-entry.html" class="nav-link active">New Job Entry</a>
            <a href="job-queue.html" class="nav-link">Job Queue</a>
            <a href="customers.html" class="nav-link">Customers</a>
            <a href="expenses.html" class="nav-link">Daily Expenses</a>
            <a href="reports.html" class="nav-link">Reports</a>
            <a href="settings.html" class="nav-link">User Management</a>
            <a href="admin-credentials.html" class="nav-link">Admin Credentials</a>
        </aside>

        <main class="main">
            <div class="page-header">
                <div>
                    <div class="page-title">New Job Entry</div>
                    <div class="page-sub">Enter details for a new job or service request.</div>
                </div>
            </div>

            <div class="card">
                <form id="jobEntryForm">
                    <div class="job-form-grid">
                        
                        <div class="field">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>

                        <div class="field">
                            <label for="customer">Customer Name / Company</label>
                            <input type="text" id="customer" name="customer" required placeholder="e.g., ABC Ltd. or Ramesh K.">
                        </div>

                        <div class="field">
                            <label for="amount">Total Billed Amount (₹)</label>
                            <input type="number" id="amount" name="amount" required min="0" step="0.01" placeholder="0.00">
                        </div>
                        
                        <div class="field">
                            <label for="received">Amount Received Now (₹)</label>
                            <input type="number" id="received" name="received" required min="0" step="0.01" value="0.00">
                        </div>

                        <div class="field">
                            <label for="status">Payment Status</label>
                            <select id="status" name="status" required>
                                <option value="Pending">Pending</option>
                                <option value="Completed">Completed (Full Payment)</option>
                                <option value="Partial">Partial Payment</option>
                            </select>
                        </div>
                        
                        <div class="field">
                            <label for="manager">Manager / Point of Contact</label>
                            <select id="manager" name="manager" required>
                                <option value="">Loading Managers...</option>
                            </select>
                        </div>

                        <div class="field full-width">
                            <label for="description">Job Description / Details</label>
                            <textarea id="description" name="description" rows="3" required placeholder="Brief description of the service provided (e.g., Business Card Design, Flex Banner Print)."></textarea>
                        </div>
                    </div>

                    <div class="calculation-display full-width">
                        Pending Balance: ₹<span id="pendingBalanceDisplay">0.00</span>
                    </div>

                    <div class="full-width">
                        <button type="submit" class="btn btn-submit" id="submitButton">Submit New Job</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Access global functions from script.js
        getManagers = window.getManagers;
        saveJobToScript = window.saveJobToScript;
        
        const form = document.getElementById('jobEntryForm');
        const dateInput = document.getElementById('date');
        const amountInput = document.getElementById('amount');
        const receivedInput = document.getElementById('received');
        const statusInput = document.getElementById('status');
        const balanceDisplay = document.getElementById('pendingBalanceDisplay');
        const submitButton = document.getElementById('submitButton');

        /**
         * Calculates and updates the pending balance display.
         */
        function updateBalance() {
            const amount = parseFloat(amountInput.value) || 0;
            const received = parseFloat(receivedInput.value) || 0;
            let balance = amount - received;
            
            // Prevent negative balance if received > amount
            if (balance < 0) {
                 balance = 0;
            }

            // Update status based on balance
            if (balance === 0) {
                statusInput.value = 'Completed';
            } else if (received > 0 && balance > 0) {
                statusInput.value = 'Partial';
            } else if (balance > 0 && received === 0) {
                statusInput.value = 'Pending';
            }
            
            balanceDisplay.textContent = balance.toFixed(2);
            balanceDisplay.classList.toggle('balance-positive', balance <= 0);
            balanceDisplay.style.color = balance > 0 ? 'var(--danger)' : 'var(--success)';
        }

        /**
         * Populates the Manager dropdown list.
         */
        function populateManagers() {
            const managerSelect = document.getElementById('manager');
            const managers = getManagers(); // Fetches the list from script.js (Local Storage)
            
            managerSelect.innerHTML = '<option value="">-- Select Manager --</option>';

            if (managers && managers.length > 0) {
                managers.forEach(manager => {
                    const option = document.createElement('option');
                    option.value = manager;
                    option.textContent = manager;
                    managerSelect.appendChild(option);
                });
            } else {
                 managerSelect.innerHTML = '<option value="">No Managers Found (Check Settings)</option>';
            }
            // Automatically select the logged-in user if they are a manager/admin
            const loggedInUser = localStorage.getItem('username');
            if (loggedInUser) {
                managerSelect.value = loggedInUser;
            }
        }
        
        /**
         * Handles form submission and data saving.
         */
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            // Final calculation check
            updateBalance();
            const pendingBalance = parseFloat(balanceDisplay.textContent);

            const jobData = {
                // Generate a simple ID based on date and time for uniqueness (or use backend ID)
                id: 'JOB-' + Date.now(), 
                date: dateInput.value,
                customer: document.getElementById('customer').value.trim(),
                description: document.getElementById('description').value.trim(),
                amount: parseFloat(amountInput.value).toFixed(2),
                received: parseFloat(receivedInput.value).toFixed(2),
                balance: pendingBalance.toFixed(2),
                status: statusInput.value,
                manager: document.getElementById('manager').value,
                entry_timestamp: new Date().toISOString()
            };

            // Confirmation dialogue
            const isConfirmed = confirm(`Confirm Job Entry:\nCustomer: ${jobData.customer}\nAmount: ₹${jobData.amount}\nBalance Due: ₹${jobData.balance}\n\nDo you want to submit this data?`);

            if (isConfirmed) {
                try {
                    // Calls the function that retrieves Admin Credentials and sends data to Google Script
                    const success = await saveJobToScript(jobData); 
                    
                    if (success) {
                        alert(`Job Entry successful! Data submitted to Google Sheet.`);
                        form.reset();
                        // Reset date to today's date after successful submission
                        dateInput.valueAsDate = new Date(); 
                        updateBalance(); // Reset calculation display
                    } else {
                        // Error alert is handled inside sendDataToScript (e.g., if credentials fail)
                    }
                } catch (error) {
                    console.error("Job submission failed:", error);
                    alert("A critical error occurred during submission. Check console.");
                }
            }
            
            submitButton.disabled = false;
            submitButton.textContent = 'Submit New Job';
        });


        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", function() {
            checkAuth(); 
            populateManagers();
            
            // Set date input to today's date
            dateInput.valueAsDate = new Date();
            
            // Attach input listeners for live balance calculation
            amountInput.addEventListener('input', updateBalance);
            receivedInput.addEventListener('input', updateBalance);
            statusInput.addEventListener('change', updateBalance);
            
            // Initial calculation display setup
            updateBalance();
        });
    </script>
</body>
</html>
