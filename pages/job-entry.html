<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
      <div id="sv_user_name"></div>
      <button id="logoutBtn" class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">

    <aside class="sidebar">
      <div class="brand-small">Actions</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link active">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">New Job Entry</div>
          <div class="page-sub">Create a new print / xerox job</div>
        </div>
      </div>

      <div class="card">
        <form id="jobForm">

          <div class="form-row">
            <div class="field">
              <label for="custName">Customer Name *</label>
              <input id="custName" name="customer" type="text" required placeholder="Customer name">
            </div>

            <div class="field">
              <label for="custContact">Contact</label>
              <input id="custContact" name="contact" type="text" placeholder="Phone or email">
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="jobType">Job Type</label>
              <select id="jobType" name="jobType">
                <option>Photocopy</option>
                <option>Printing - Color</option>
                <option>Printing - B/W</option>
                <option>Binding</option>
                <option>Scanning</option>
              </select>
            </div>

            <div class="field">
              <label for="qty">Quantity</label>
              <input id="qty" name="qty" type="number" value="1" min="1">
            </div>
          </div>
          
          <div class="form-row" id="bindingTypeField" style="display: none;">
            <div class="field full-width">
              <label for="bindingType">Binding Type *</label>
              <select id="bindingType" name="bindingType">
                <option value="" disabled selected>Select binding type</option>
                <option>Spiral</option>
                <option>Perfect</option>
                <option>Wiro</option>
                <option>Staple</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="assignedUser">Assign Task To *</label>
              <select id="assignedUser" name="assignedUser" required>
                <option value="" disabled selected>-- Select User --</option>
                <option value="user_a">Data Entry Clerk</option>
                <option value="user_b">Checker</option>
                <option value="user_c">Printer Operator</option>
                <option value="user_d">Finisher</option>
                <option value="admin">Admin (Completion)</option>
              </select>
            </div>

            <div class="field">
              <label for="department">Assigned Department</label>
              <select id="department" name="department">
                <option>Data Entry</option>
                <option>Checking</option>
                <option>Printing</option>
                <option>Finishing</option>
                <option>Delivery</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="field full-width">
              <label for="urgency">Urgency</label>
              <select id="urgency" name="urgency">
                <option>Normal</option>
                <option>Express</option>
              </select>
            </div>
          </div>


          <div style="margin-top:14px;">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Extra instructions"></textarea>
          </div>

          <div style="margin-top:16px; display:flex; gap:10px;">
            <button type="submit" class="btn">Create Job</button>
            <button type="button" class="btn secondary" onclick="location.href='job-queue.html'">Open Queue</button>
          </div>

        </form>
      </div>
    </main>
  </div>

  <script src="https://nil4567.github.io/Siddhivinayak_Digital/data/config.js"></script>
  <script src="https://nil4567.github.io/Siddhivinayak_Digital/script.js"></script>

  <script>
    checkLogin();

    // ðŸ”´ TEMPORARY FUNCTION for Sequential ID 
    // This MUST be implemented on your server for true sequential numbers.
    async function getSequentialJobId() {
        return "J-" + Date.now().toString().slice(-6); 
    }

    // --- DYNAMIC FIELD LOGIC (NEW) ---
    document.getElementById('jobType').addEventListener('change', function() {
        const jobType = this.value;
        const bindingField = document.getElementById('bindingTypeField');
        const bindingSelect = document.getElementById('bindingType');

        if (jobType === 'Binding') {
            bindingField.style.display = 'flex'; // Show the field row
            bindingSelect.setAttribute('required', 'required'); // Make the select box mandatory
        } else {
            bindingField.style.display = 'none'; // Hide the field row
            bindingSelect.removeAttribute('required'); // Remove mandatory requirement
            bindingSelect.value = bindingSelect.options[0].value; // Reset the value
        }
    });
    // --- END DYNAMIC FIELD LOGIC ---

    document.getElementById("jobForm").addEventListener("submit", async function(ev) {
      ev.preventDefault();

      const newId = await getSequentialJobId();
      const jobType = document.getElementById('jobType').value;
      const bindingType = jobType === 'Binding' ? document.getElementById('bindingType').value : null;

      const job = {
        id: newId,
        date: new Date().toISOString(),
        customer: document.getElementById('custName').value,
        contact: document.getElementById('custContact').value,
        jobType: jobType,
        
        // Include the conditional field
        bindingType: bindingType, 
        
        qty: Number(document.getElementById('qty').value) || 1,
        assignedUser: document.getElementById('assignedUser').value, // NEW REQUIRED FIELD
        department: document.getElementById('department').value,
        urgency: document.getElementById('urgency').value,
        notes: document.getElementById('notes').value,
        status: "Pending",
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      console.log("Submitting Job:", job);

      // The saveJobToGitHub function needs to be updated to handle the new fields
      const ok = await saveJobToGitHub(job); 

      if (ok) {
        alert("Job created and saved: " + job.id);
        window.location.href = "job-queue.html";
      } else {
        alert("Failed to save job. Check console.");
      }
    });
  </script>

</body>
