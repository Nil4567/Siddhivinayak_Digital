<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>New Job Entry — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    .entry-form {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .full-width {
      grid-column: 1 / -1;
    }
    .total-display {
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 15px;
      padding: 10px;
      background-color: var(--highlight);
      border-radius: 6px;
      text-align: right;
    }
    .btn-save {
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link active">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="expenses.html" class="nav-link">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">User Settings</a>
      <a href="admin-credentials.html" class="nav-link">Admin Credentials</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">New Job Entry</div>
          <div class="page-sub">Enter details for a new job received from a customer.</div>
        </div>
      </div>

      <div class="card entry-form">
        <h3>Job Details</h3>
        <form id="jobEntryForm">
          <div class="grid-2">
            <div class="field">
              <label for="jobDate">Date *</label>
              <input type="date" id="jobDate" required>
            </div>
            <div class="field">
              <label for="customerName">Customer Name *</label>
              <input type="text" id="customerName" required placeholder="e.g., Rohan Patil">
            </div>
            
            <div class="field full-width">
              <label for="jobDescription">Job Description *</label>
              <textarea id="jobDescription" rows="3" required placeholder="e.g., 500 A4 color prints, 10 laminated posters"></textarea>
            </div>
            
            <div class="field">
              <label for="jobAmount">Total Job Amount (₹) *</label>
              <input type="number" id="jobAmount" required min="0" step="0.01" value="0.00">
            </div>
            <div class="field">
              <label for="amountReceived">Amount Received (₹) *</label>
              <input type="number" id="amountReceived" required min="0" step="0.01" value="0.00">
            </div>

            <div class="field full-width">
              <label for="manager">Manager/Operator Handling Job *</label>
              <select id="manager" required>
                </select>
            </div>
          </div>
          
          <div class="total-display">
            Balance Remaining: ₹ <span id="balanceAmount">0.00</span>
          </div>

          <button type="submit" class="btn btn-save">Save Job & Clear Form</button>
        </form>
      </div>

    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // Access global functions from script.js
    const saveJobToScript = window.saveJobToScript;
    const getManagers = window.getManagers;
    
    // --- Utility Functions ---
    function updateBalance() {
      const amount = parseFloat(document.getElementById('jobAmount').value) || 0;
      const received = parseFloat(document.getElementById('amountReceived').value) || 0;
      const balance = amount - received;
      
      const balanceEl = document.getElementById('balanceAmount');
      balanceEl.textContent = balance.toFixed(2);
      
      // Highlight if balance is negative or positive
      balanceEl.style.color = balance > 0 ? 'var(--danger)' : (balance < 0 ? 'var(--primary)' : 'var(--success)');
    }
    
    function populateManagerDropdown() {
      const select = document.getElementById('manager');
      const managers = getManagers(); 
      select.innerHTML = '<option value="">-- Select Manager --</option>';

      if (managers && managers.length > 0) {
        managers.forEach(manager => {
          const option = document.createElement('option');
          option.value = manager;
          option.textContent = manager;
          select.appendChild(option);
        });
        // Pre-select the logged-in user if available
        const loggedInUser = localStorage.getItem('username');
        if (loggedInUser && managers.includes(loggedInUser)) {
            select.value = loggedInUser;
        }
      }
    }

    // --- Form Submission Handler ---
    document.getElementById('jobEntryForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const form = e.target;
      const jobDate = form.jobDate.value;
      const customerName = form.customerName.value.trim();
      const jobDescription = form.jobDescription.value.trim();
      const jobAmount = parseFloat(form.jobAmount.value) || 0;
      const amountReceived = parseFloat(form.amountReceived.value) || 0;
      const balance = jobAmount - amountReceived;
      const manager = form.manager.value;

      // Simple validation check
      if (jobAmount < 0 || amountReceived < 0) {
        alert("Amounts cannot be negative.");
        return;
      }
      
      const newJob = {
        date: jobDate,
        customer: customerName,
        description: jobDescription,
        amount: jobAmount,
        received: amountReceived,
        balance: balance,
        manager: manager,
        status: balance > 0 ? 'Pending' : 'Completed' // Simple status logic
      };
      
      // Call the external save function
      const success = await saveJobToScript(newJob);

      if (success) {
        alert(`Job for ${customerName} saved successfully! Balance: ₹${balance.toFixed(2)}`);
        form.reset();
        // Set date to today after reset
        document.getElementById('jobDate').valueAsDate = new Date();
        // Recalculate balance display after reset
        updateBalance();
      } else {
        // saveJobToScript alerts the user on failure
        console.error("Job saving failed.");
      }
    });

    // --- Initialization ---
    document.addEventListener("DOMContentLoaded", function() {
      // 1. Check Auth & Load Header/Sidebar (from script.js)
      checkAuth(); 
      
      // 2. Set the default date to today
      document.getElementById('jobDate').valueAsDate = new Date();
      
      // 3. Populate managers
      populateManagerDropdown();

      // 4. Set up live balance calculation
      document.getElementById('jobAmount').addEventListener('input', updateBalance);
      document.getElementById('amountReceived').addEventListener('input', updateBalance);
      
      // Initial balance display
      updateBalance();
    });
  </script>
</body>
</html>
