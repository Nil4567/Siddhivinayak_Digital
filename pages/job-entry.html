<script>
    // Run this function after checkAuth() has ensured the user is logged in
    document.addEventListener("DOMContentLoaded", function() {
        // --- Access Control Navigation Filter ---
        const userRole = localStorage.getItem("sv_user_role");
        const allowedPages = ACCESS_PERMISSIONS[userRole] || [];
        
        const navLinks = document.querySelectorAll('.sidebar .nav-link');
        
        navLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                const pageName = href.split('/').pop();
                
                // Hide the link if the current role doesn't have permission
                if (!allowedPages.includes(pageName)) {
                    link.style.display = 'none';
                }
            }
        });
    });
</script>
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>New Job Entry — Siddhivinayak Digital</title>
  <link rel="stylesheet" href="../styles/internal.css">
  <style>
    .user-display {
        background: #e9f2ff; 
        color: #0b2540;
        padding: 5px 10px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        margin-right: 15px;
        border: 1px solid rgba(15,111,255,0.1);
    }
    .user-display span {
        font-weight: 800;
        color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Siddhivinayak Digital</div>
    <div class="controls">
        <button class="btn secondary" onclick="history.back()">Back</button>
        <a href="../index.html" class="btn secondary">Home</a>
        <div class="user-display">Logged in as: <span id="sv_user_name"></span></div>
        <span id="liveTime"></span>
        <button class="btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand-small">Control Panel</div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
      <a href="job-entry.html" class="nav-link active">New Job Entry</a>
      <a href="job-queue.html" class="nav-link">Job Queue</a>
      <a href="customers.html" class="nav-link">Customers</a>
      <a href="expenses.html" class="nav-link">Daily Expenses</a>
      <a href="reports.html" class="nav-link">Reports</a>
      <a href="settings.html" class="nav-link">Settings</a>
    </aside>

    <main class="main">
      <div class="page-header">
        <div>
          <div class="page-title">New Job Entry</div>
          <div class="page-sub">Enter all details for a new customer order.</div>
        </div>
      </div>

      <div class="card">
        <h3>Customer and Job Details</h3>
        <form id="newJobForm">
            <div class="form-row">
                <div class="field">
                    <label for="customer">Customer Name *</label>
                    <input type="text" id="customer" name="customer" required>
                </div>
                <div class="field">
                    <label for="contact">Contact Number</label>
                    <input type="text" id="contact" name="contact">
                </div>
            </div>

            <div class="form-row">
                <div class="field">
                    <label for="description">Job Description / Instructions *</label>
                    <textarea id="description" name="description" rows="3" required></textarea>
                </div>
            </div>
            
            <div class="form-row">
                <div class="field">
                    <label for="amount">Total Amount (₹) *</label>
                    <input type="number" id="amount" name="amount" required min="1" step="1">
                </div>
                <div class="field">
                    <label for="advance">Advance Paid (₹)</label>
                    <input type="number" id="advance" name="advance" value="0" min="0" step="1">
                </div>
            </div>
            
            <div class="form-row">
                <div class="field">
                    <label for="assignedPerson">Assigned Manager *</label>
                    <select id="assignedPerson" name="assignedPerson" required>
                        <option value="Admin">Loading Managers...</option> 
                    </select>
                </div>
                <div class="field">
                    <label for="orderDate">Order Date</label>
                    <input type="date" id="orderDate" name="orderDate" required>
                </div>
            </div>

            <p id="submissionMessage" style="color: green; font-weight: 700; margin-top: 15px; display: none;"></p>
            <button type="submit" class="btn" style="margin-top: 20px;">Submit New Job</button>
        </form>
      </div>
    </main>
  </div>

  <script src="../script.js"></script>
  <script>
    // Get the utility functions from script.js
    const getManagers = window.getManagers;
    
    // --- Helper function to populate managers ---
    function populateManagers() {
        const select = document.getElementById('assignedPerson');
        const managers = getManagers(); // Fetches the list from localStorage via script.js
        
        select.innerHTML = ''; // Clear existing options
        
        if (managers && managers.length > 0) {
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                select.appendChild(option);
            });
            
            // Set the default selection: current user > 'Admin' > first manager
            const currentUser = localStorage.getItem('username');
            if (managers.includes(currentUser)) {
                select.value = currentUser;
            } else if (managers.includes('Admin')) {
                 select.value = 'Admin';
            } else {
                select.value = managers[0];
            }
        } else {
             // Fallback if list is empty
             select.innerHTML = '<option value="Admin">Admin</option>';
        }
    }


    // --- Form Submission Logic ---
    document.getElementById('newJobForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const amount = parseFloat(form.amount.value) || 0;
        const advance = parseFloat(form.advance.value) || 0;
        const pendingAmount = amount - advance;
        
        if (pendingAmount < 0) {
            alert("Error: Advance amount cannot be more than the total amount.");
            return;
        }

        const newJob = {
            id: 'J-' + Date.now().toString().slice(-6),
            customer: form.customer.value.trim(),
            contact: form.contact.value.trim(),
            description: form.description.value.trim(),
            amount: amount.toFixed(0), // Store as whole number string
            advance: advance.toFixed(0),
            pendingAmount: pendingAmount.toFixed(0),
            orderDate: form.orderDate.value,
            // Capture the manager from the dynamic dropdown
            assignedPerson: form.assignedPerson.value, 
            status: 'Pending',
            createdAt: new Date().toISOString(),
            enteredBy: localStorage.getItem('username') || 'Unknown'
        };

        // 1. Save to Local Storage (Always save locally first)
        const allJobs = JSON.parse(localStorage.getItem('sv_jobs') || '[]');
        allJobs.push(newJob);
        localStorage.setItem('sv_jobs', JSON.stringify(allJobs));

        // 2. Dispatch to GitHub (For persistent storage)
        const msgEl = document.getElementById('submissionMessage');
        msgEl.style.color = 'orange';
        msgEl.textContent = `Job #${newJob.id} saved locally. Dispatching to central record...`;
        msgEl.style.display = 'block';

        let success = true;
        try {
            if (typeof saveJobToGitHub === 'function') {
                success = await saveJobToGitHub(newJob); 
            } else {
                console.warn("saveJobToGitHub function not found. Job saved locally only.");
            }
        } catch (e) {
            console.error("Error during GitHub dispatch:", e);
            success = false;
        }

        if (success) {
            msgEl.style.color = 'green';
            msgEl.textContent = `✅ Job #${newJob.id} submitted successfully and saved to central record!`;
        } else {
            msgEl.style.color = 'red';
            msgEl.textContent = `❌ Job #${newJob.id} saved locally, but failed to reach central record (GitHub/Sheet). Check console for error.`;
        }
        
        // Reset form for next entry
        form.reset();
        document.getElementById('orderDate').valueAsDate = new Date();
        populateManagers(); // Re-populate to ensure default selection is correct
    });

    // --- Initialization ---
    document.addEventListener("DOMContentLoaded", function() {
        checkAuth();
        populateManagers();
        // Set default date to today
        document.getElementById('orderDate').valueAsDate = new Date();
    });
  </script>
</body>
</html>
